<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Progress Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Add a class for the open state of the details element for the chevron icon */
        details[open]>summary .chevron {
            transform: rotate(180deg);
        }

        /* Custom modal styles */
        #confirmation-modal {
            transition: opacity 0.3s ease-in-out;
        }

        #confirmation-modal.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #modal-content {
            transform: scale(0.95);
            transition: transform 0.3s ease-in-out;
        }

        #confirmation-modal:not(.hidden) #modal-content {
            transform: scale(1);
        }

        /* Styles for the preview content */
        .preview-section {
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 1.5rem;
        }

        .preview-section:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .preview-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e3a8a;
            /* text-blue-900 */
            margin-bottom: 1rem;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .preview-item {
            background-color: #f9fafb;
            /* bg-gray-50 */
            padding: 0.75rem;
            border-radius: 0.375rem;
            border: 1px solid #f3f4f6;
        }

        .preview-item-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #4b5563;
            /* text-gray-600 */
            display: block;
            margin-bottom: 0.25rem;
        }

        .preview-item-value {
            font-size: 1rem;
            color: #1f2937;
            /* text-gray-800 */
            word-wrap: break-word;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .preview-table th,
        .preview-table td {
            text-align: left;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            /* border-gray-300 */
            vertical-align: top;
        }

        .preview-table th {
            background-color: #e0f2fe;
            /* bg-blue-100 */
            font-weight: 600;
        }


        /* --- Responsive Table Styles --- */
        /* Applied on screens smaller than 1024px (tablets and phones) */
        @media (max-width: 1024px) {
            .responsive-table thead {
                display: none;
                /* Hide headers, labels are in cells */
            }

            .responsive-table>tbody>tr:not(.category-header) {
                display: block;
                margin-bottom: 1rem;
                border-radius: 0.5rem;
                border: 1px solid #d1d5db;
                /* border-gray-300 */
                background-color: #ffffff;
                /* bg-white */
                overflow: hidden;
                /* Ensures child borders don't spill out */
            }

            .responsive-table>tbody>tr.category-header {
                display: table-row;
                /* Keep category headers as is */
            }

            .responsive-table>tbody>tr.category-header>td {
                display: table-cell;
            }

            .responsive-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.75rem 1rem;
                text-align: left;
                border-bottom: 1px solid #e5e7eb;
                /* border-gray-200 */
            }

            .responsive-table tr:not(.category-header) td:last-child {
                border-bottom: none;
            }

            .responsive-table td[data-label]::before {
                content: attr(data-label);
                font-weight: 600;
                padding-right: 1rem;
                flex-shrink: 0;
                /* Prevent label from shrinking */
                color: #374151;
                /* text-gray-700 */
            }

            /* Cells with complex content need vertical stacking on mobile */
            .responsive-table td.responsive-cell-block {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .responsive-table td.responsive-cell-block::before {
                margin-bottom: 0.25rem;
                font-size: 0.875rem;
                /* text-sm */
                color: #1e3a8a;
                /* text-blue-900 */
            }

            .responsive-table td.responsive-cell-block>* {
                width: 100%;
            }

            /* Center the delete button */
            .responsive-table td.action-cell {
                justify-content: center;
                padding: 0.5rem;
                background-color: #f9fafb;
                /* bg-gray-50 */
            }

            .responsive-table td.action-cell::before {
                display: none;
                /* No label needed for action cell */
            }

            /* Make inputs full-width within their flex container */
            .responsive-table td input,
            .responsive-table td select,
            .responsive-table td textarea {
                flex-grow: 1;
                min-width: 50%;
                /* Ensure input has enough space */
            }

            /* Override some default styles for a cleaner look */
            .responsive-table td:not(.action-cell) {
                border-left: none;
                border-right: none;
                border-top: none;
            }

            .responsive-table .p-1 {
                padding: 0;
            }
        }
    </style>
</head>

<body class="bg-gray-100">
    <div class="container max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 my-8 bg-white rounded-xl shadow-lg">
        <header class="flex flex-col sm:flex-row justify-between items-center border-b-4 border-red-600 pb-4 mb-8">
            <h1 class="text-2xl sm:text-3xl font-bold text-blue-900 text-center sm:text-left">Daily Progress Report</h1>
            <div class="flex items-center gap-4 mt-4 sm:mt-0">
                <div id="admin-nav" class="flex items-center gap-2">
                    <div id="notif-wrapper" class="relative">
                        <button id="notif-button" type="button"
                            class="relative inline-flex items-center justify-center w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 focus:outline-none"
                            aria-label="Notifications">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path
                                    d="M10 2a6 6 0 00-6 6v2.586l-.707.707A1 1 0 004 13h12a1 1 0 00.707-1.707L16 10.586V8a6 6 0 00-6-6z" />
                                <path d="M14 14a4 4 0 11-8 0h8z" />
                            </svg>
                            <span id="notif-badge"
                                class="hidden absolute -top-1 -right-1 bg-red-600 text-white text-xs rounded-full px-1">0</span>
                        </button>
                        <div id="notif-dropdown"
                            class="hidden absolute z-20 mt-2 w-80 max-h-96 overflow-auto right-auto left-0 bg-white border border-gray-200 rounded-md shadow-lg">
                            <div class="px-4 py-2 border-b text-sm font-semibold text-gray-700">Last 48 hours</div>
                            <ul id="notif-list" class="divide-y divide-gray-100 max-h-80 overflow-y-auto"></ul>
                            <div class="px-4 py-2 text-xs text-gray-500">Notifications auto-expire after 48 hours</div>
                        </div>
                    </div>
                    <a href="/view-reports"
                        class="bg-gray-700 text-white px-4 py-2 rounded-md hover:bg-gray-800 transition text-sm">View
                        Reports</a>
                    <a href="/admin/login" id="admin-login-btn"
                        class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition text-sm">Admin
                        Login</a>
                    <div id="admin-logged-in" class="hidden flex items-center gap-2">
                        <a href="/admin"
                            class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition text-sm">Manage
                            Data</a>
                        <a href="/admin/logout"
                            class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition text-sm">Logout</a>
                    </div>
                </div>
                <img src="https://simonindia.com/assets/images/logo.png" alt="SIMON India Logo" class="h-12">
            </div>
        </header>

        <form class="report-form">
            <section class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-8">
                <div>
                    <label for="project-code" class="block text-sm font-medium text-gray-700">Project Code <span
                            class="text-red-500">*</span></label>
                    <select id="project-code" name="project-code"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-700 focus:ring focus:ring-blue-600 focus:ring-opacity-50">
                        <option value="">-- Select Project --</option>
                    </select>
                </div>
                <div>
                    <label for="project-name" class="block text-sm font-medium text-gray-700">Project Name</label>
                    <input type="text" id="project-name" name="project-name" readonly
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-100">
                </div>
                <div>
                    <label for="date" class="block text-sm font-medium text-gray-700">Date</label>
                    <input type="text" id="date" name="date" placeholder="dd.mm.yyyy"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-700 focus:ring focus:ring-blue-600 focus:ring-opacity-50">
                </div>
                <div>
                    <label for="report-no" class="block text-sm font-medium text-gray-700">Report No.</label>
                    <input type="text" id="report-no" name="report-no" readonly
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-100">
                </div>
                <div>
                    <label for="project-manager" class="block text-sm font-medium text-gray-700">Project Manager
                        (Contractor)</label>
                    <input type="text" id="project-manager" name="project-manager" readonly
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-100">
                </div>
                <div>
                    <label for="project-manager-client" class="block text-sm font-medium text-gray-700">Project Manager
                        (Client)</label>
                    <input type="text" id="project-manager-client" name="project-manager-client" readonly
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-100">
                </div>
                <div>
                    <label for="target-completion" class="block text-sm font-medium text-gray-700">Target
                        Completion</label>
                    <input type="text" id="target-completion" name="target-completion" readonly
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-100">
                </div>
                <div>
                    <label for="client" class="block text-sm font-medium text-gray-700">Client</label>
                    <input type="text" id="client" name="client" readonly
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-100">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Weather</label>
                    <div class="flex gap-2 mt-1">
                        <input type="number" placeholder="Max Temp (¬∞C)" aria-label="Maximum Temperature"
                            class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-700 focus:ring focus:ring-blue-600 focus:ring-opacity-50">
                        <input type="number" placeholder="Min Temp (¬∞C)" aria-label="Minimum Temperature"
                            class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-700 focus:ring focus:ring-blue-600 focus:ring-opacity-50">
                    </div>
                </div>
                <div>
                    <label for="contractor" class="block text-sm font-medium text-gray-700">Contractor</label>
                    <input type="text" id="contractor" name="contractor" readonly
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-100">
                </div>
                <div>
                    <label for="subcontractor-deployed" class="block text-sm font-medium text-gray-700">Subcontractor
                        Deployed</label>
                    <input type="text" id="subcontractor-deployed" name="subcontractor-deployed"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-700 focus:ring focus:ring-blue-600 focus:ring-opacity-50">
                </div>
            </section>

            <details class="collapsible-section border border-gray-200 rounded-lg mb-8" open>
                <summary
                    class="flex items-center justify-between w-full bg-blue-50 hover:bg-blue-100 p-4 text-lg font-semibold text-blue-900 cursor-pointer list-none">
                    Construction Work Progress
                    <svg class="chevron w-5 h-5 text-blue-900 transform transition-transform duration-200"
                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </summary>
                <div class="overflow-x-auto">
                    <table id="work-progress-table" class="min-w-full responsive-table">
                        <thead class="bg-blue-100">
                            <tr>
                                <th
                                    class="p-3 text-left text-xs font-semibold text-blue-900 uppercase tracking-wider border border-gray-300 w-5/12">
                                    Activity &amp; Details</th>
                                <th
                                    class="p-3 text-left text-xs font-semibold text-blue-900 uppercase tracking-wider border border-gray-300 w-3/12">
                                    Today's Plan</th>
                                <th
                                    class="p-3 text-left text-xs font-semibold text-blue-900 uppercase tracking-wider border border-gray-300 w-3/12">
                                    Cumulative Progress</th>
                                <th
                                    class="p-3 text-center text-xs font-semibold text-blue-900 uppercase tracking-wider border border-gray-300">
                                    Action</th>
                            </tr>
                        </thead>
                        <!-- Project-specific sections will be loaded dynamically here -->
                    </table>
                </div>
                <div class="p-4 flex flex-col sm:flex-row gap-4 border-t border-gray-200">
                    <input type="text" id="new-section-name" placeholder="New Section Name (e.g., Electrical)"
                        class="flex-grow rounded-md border-gray-300 shadow-sm focus:border-blue-700 focus:ring focus:ring-blue-600 focus:ring-opacity-50">
                    <button type="button" id="add-section-btn"
                        class="add-row-btn bg-blue-800 text-white px-4 py-2 rounded-md shadow hover:bg-blue-700 transition">Add
                        Section</button>
                </div>
            </details>

            <details class="collapsible-section border border-gray-200 rounded-lg mb-8" open>
                <summary
                    class="flex items-center justify-between w-full bg-blue-50 hover:bg-blue-100 p-4 text-lg font-semibold text-blue-900 cursor-pointer list-none">
                    Manpower & Equipment
                    <svg class="chevron w-5 h-5 text-blue-900 transform transition-transform duration-200"
                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </summary>

                <div class="p-4">
                    <h3 class="text-md font-semibold text-blue-800 mb-2">Manpower Details</h3>
                    <div class="overflow-x-auto">
                        <table id="manpower-table" class="min-w-full responsive-table">
                            <thead class="bg-blue-100">
                                <tr>
                                    <th
                                        class="p-3 text-center text-xs font-semibold text-blue-900 uppercase tracking-wider border border-gray-300">
                                        Manpower Designation</th>
                                    <th
                                        class="p-3 text-center text-xs font-semibold text-blue-900 uppercase tracking-wider border border-gray-300">
                                        No. of Manpower</th>
                                    <th
                                        class="p-3 text-center text-xs font-semibold text-blue-900 uppercase tracking-wider border border-gray-300">
                                        Type (Direct/Indirect)</th>
                                    <th
                                        class="p-3 text-center text-xs font-semibold text-blue-900 uppercase tracking-wider border border-gray-300">
                                        Department</th>
                                    <th
                                        class="p-3 text-center text-xs font-semibold text-blue-900 uppercase tracking-wider border border-gray-300">
                                        Contractor</th>
                                    <th
                                        class="p-3 text-center text-xs font-semibold text-blue-900 uppercase tracking-wider border border-gray-300">
                                        Action</th>
                                </tr>
                            </thead>
                            <tbody id="manpower-body" class="divide-y divide-gray-200">
                                <!-- Rows will be added dynamically -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4">
                        <button type="button" id="add-manpower-row"
                            class="add-row-btn bg-blue-800 text-white px-4 py-2 rounded-md shadow hover:bg-blue-700 transition">Add
                            Manpower Row</button>
                    </div>
                </div>

                <div class="p-4">
                    <h3 class="text-md font-semibold text-blue-800 mb-2">Equipment Details</h3>
                    <div class="overflow-x-auto">
                        <table id="equipment-table" class="min-w-full responsive-table">
                            <thead class="bg-blue-100">
                                <tr>
                                    <th
                                        class="p-3 text-center text-xs font-semibold text-blue-900 uppercase tracking-wider border border-gray-300">
                                        Description</th>
                                    <th
                                        class="p-3 text-center text-xs font-semibold text-blue-900 uppercase tracking-wider border border-gray-300">
                                        No.</th>
                                    <th
                                        class="p-3 text-center text-xs font-semibold text-blue-900 uppercase tracking-wider border border-gray-300">
                                        Effective Hours</th>
                                    <th
                                        class="p-3 text-center text-xs font-semibold text-blue-900 uppercase tracking-wider border border-gray-300">
                                        Idle Hours</th>
                                    <th
                                        class="p-3 text-center text-xs font-semibold text-blue-900 uppercase tracking-wider border border-gray-300">
                                        Department</th>
                                    <th
                                        class="p-3 text-center text-xs font-semibold text-blue-900 uppercase tracking-wider border border-gray-300">
                                        Contractor</th>
                                    <th
                                        class="p-3 text-center text-xs font-semibold text-blue-900 uppercase tracking-wider border border-gray-300">
                                        Action</th>
                                </tr>
                            </thead>
                            <tbody id="equipment-body" class="divide-y divide-gray-200">
                                <!-- Rows will be added dynamically -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4">
                        <button type="button" id="add-equipment-row"
                            class="add-row-btn bg-blue-800 text-white px-4 py-2 rounded-md shadow hover:bg-blue-700 transition">Add
                            Equipment Row</button>
                    </div>
                </div>
            </details>

            <details class="collapsible-section border border-gray-200 rounded-lg mb-8" open>
                <summary
                    class="flex items-center justify-between w-full bg-blue-50 hover:bg-blue-100 p-4 text-lg font-semibold text-blue-900 cursor-pointer list-none">
                    Concerns & Incidents
                    <svg class="chevron w-5 h-5 text-blue-900 transform transition-transform duration-200"
                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </summary>
                <div class="p-6 grid grid-cols-1 gap-6">
                    <div>
                        <label for="quality-concerns" class="block text-sm font-medium text-gray-700">Any Quality
                            concerns</label>
                        <textarea id="quality-concerns" name="quality-concerns" rows="2"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-700 focus:ring focus:ring-blue-600 focus:ring-opacity-50"></textarea>
                    </div>
                    <div>
                        <label for="mitigation" class="block text-sm font-medium text-gray-700">Mitigation (for
                            mentioned concern)</label>
                        <textarea id="mitigation" name="mitigation" rows="2"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-700 focus:ring focus:ring-blue-600 focus:ring-opacity-50"></textarea>
                    </div>
                    <div>
                        <label for="safety-incident" class="block text-sm font-medium text-gray-700">Any Safety
                            incident</label>
                        <textarea id="safety-incident" name="safety-incident" rows="2"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-700 focus:ring focus:ring-blue-600 focus:ring-opacity-50"></textarea>
                    </div>
                    <div>
                        <label for="action-avoidance" class="block text-sm font-medium text-gray-700">Action for
                            avoidance</label>
                        <textarea id="action-avoidance" name="action-avoidance" rows="2"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-700 focus:ring focus:ring-blue-600 focus:ring-opacity-50"></textarea>
                    </div>
                </div>
            </details>

            <details class="collapsible-section border border-gray-200 rounded-lg mb-8" open>
                <summary
                    class="flex items-center justify-between w-full bg-blue-50 hover:bg-blue-100 p-4 text-lg font-semibold text-blue-900 cursor-pointer list-none">
                    Critical Issues
                    <svg class="chevron w-5 h-5 text-blue-900 transform transition-transform duration-200"
                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </summary>
                <div class="overflow-x-auto">
                    <table id="issues-table" class="min-w-full responsive-table">
                        <thead class="bg-blue-100">
                            <tr>
                                <th
                                    class="p-3 text-center text-xs font-semibold text-blue-900 uppercase tracking-wider border border-gray-300">
                                    Issues</th>
                                <th
                                    class="p-3 text-center text-xs font-semibold text-blue-900 uppercase tracking-wider border border-gray-300">
                                    Raised (Date)</th>
                                <th
                                    class="p-3 text-center text-xs font-semibold text-blue-900 uppercase tracking-wider border border-gray-300">
                                    Work Affected</th>
                                <th
                                    class="p-3 text-center text-xs font-semibold text-blue-900 uppercase tracking-wider border border-gray-300">
                                    Action</th>
                            </tr>
                        </thead>
                        <tbody id="issues-body" class="divide-y divide-gray-200">
                            <tr>
                                <td class="border border-gray-300 p-1" data-label="Issues"><textarea rows="1"
                                        placeholder="Describe the issue"
                                        class="w-full border-none focus:ring-0 bg-transparent p-1"></textarea></td>
                                <td class="border border-gray-300 p-1" data-label="Raised (Date)"><input type="text"
                                        placeholder="dd.mm.yyyy"
                                        class="w-full border-none focus:ring-0 bg-transparent p-1"></td>
                                <td class="border border-gray-300 p-1" data-label="Work Affected"><textarea rows="1"
                                        placeholder="Describe work affected"
                                        class="w-full border-none focus:ring-0 bg-transparent p-1"></textarea></td>
                                <td class="border border-gray-300 text-center action-cell"><button type="button"
                                        class="delete-row-btn bg-transparent border-none text-red-600 hover:text-red-800 text-xl p-1"
                                        aria-label="Delete Row">üóëÔ∏è</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="p-4 border-t border-gray-200">
                    <button type="button" id="add-issue-row"
                        class="add-row-btn bg-blue-800 text-white px-4 py-2 rounded-md shadow hover:bg-blue-700 transition">Add
                        Issue Row</button>
                </div>
            </details>

            <footer class="grid grid-cols-1 md:grid-cols-3 gap-8 mt-8 pt-8 border-t-2 border-gray-300">
                <div class="signature-block">
                    <h4 class="text-lg font-semibold text-blue-900 border-b border-gray-200 pb-2 mb-4">Prepared By</h4>
                    <div class="space-y-4">
                        <div>
                            <label for="prep-name" class="block text-sm font-medium text-gray-700">Name <span
                                    class="text-red-500">*</span></label>
                            <select id="prep-name"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-700 focus:ring focus:ring-blue-600 focus:ring-opacity-50"></select>
                        </div>
                        <div>
                            <label for="prep-des" class="block text-sm font-medium text-gray-700">Designation</label>
                            <input type="text" id="prep-des" readonly
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-100">
                        </div>
                    </div>
                </div>
                <div class="signature-block">
                    <h4 class="text-lg font-semibold text-blue-900 border-b border-gray-200 pb-2 mb-4">Initiated by
                        Contractor</h4>
                    <div class="space-y-4">
                        <div>
                            <label for="init-contractor-name" class="block text-sm font-medium text-gray-700">Contractor
                                Name <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <!-- Multi-select container -->
                                <div id="init-contractor-multi-select"
                                    class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus-within:border-blue-700 focus-within:ring focus-within:ring-blue-600 focus-within:ring-opacity-50 bg-white min-h-[42px] p-2 cursor-pointer">
                                    <!-- Selected chips container -->
                                    <div id="init-contractor-chips" class="flex flex-wrap gap-2 mb-1"></div>
                                    <!-- Placeholder text -->
                                    <div id="init-contractor-placeholder" class="text-gray-400 text-sm">-- Select
                                        Contractors --</div>
                                </div>
                                <!-- Dropdown menu -->
                                <div id="init-contractor-dropdown"
                                    class="hidden absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto">
                                    <!-- Options will be populated dynamically -->
                                </div>
                                <!-- Hidden input to store selected values -->
                                <input type="hidden" id="init-contractor-name" />
                            </div>
                        </div>
                        <div>
                            <label for="init-name" class="block text-sm font-medium text-gray-700">Representative Name
                                <span class="text-red-500">*</span></label>
                            <input type="text" id="init-name"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-700 focus:ring focus:ring-blue-600 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="init-des" class="block text-sm font-medium text-gray-700">Designation</label>
                            <input type="text" id="init-des"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-700 focus:ring focus:ring-blue-600 focus:ring-opacity-50">
                        </div>
                    </div>
                </div>
                <div class="signature-block">
                    <h4 class="text-lg font-semibold text-blue-900 border-b border-gray-200 pb-2 mb-4">Verified by (Site
                        Manager)</h4>
                    <div class="space-y-4">
                        <div>
                            <label for="ver-name" class="block text-sm font-medium text-gray-700">Name <span
                                    class="text-red-500">*</span></label>
                            <select id="ver-name"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-700 focus:ring focus:ring-blue-600 focus:ring-opacity-50"></select>
                        </div>
                        <div>
                            <label for="ver-des" class="block text-sm font-medium text-gray-700">Designation</label>
                            <input type="text" id="ver-des" readonly
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-100">
                        </div>
                    </div>
                </div>
            </footer>

            <div class="mt-12 text-center">
                <button type="button" id="submit-report-btn"
                    class="bg-green-600 text-white px-8 py-3 rounded-md shadow-lg hover:bg-green-700 transition-all text-lg font-semibold w-full sm:w-auto">
                    Preview & Submit Report
                </button>
            </div>
        </form>

        <script>
            (function () {
                const btn = document.getElementById('notif-button');
                const dd = document.getElementById('notif-dropdown');
                const list = document.getElementById('notif-list');
                const badge = document.getElementById('notif-badge');
                if (!btn || !dd || !list || !badge) return;

                function timeAgo(iso) {
                    try {
                        if (iso && iso.endsWith('Z')) iso = iso.slice(0, -1);
                        const then = new Date(iso);
                        const now = new Date();
                        const diffMs = now - then;
                        const minutes = Math.floor(diffMs / 60000);
                        if (minutes < 1) return 'just now';
                        if (minutes < 60) return minutes + 'm ago';
                        const hours = Math.floor(minutes / 60);
                        if (hours < 24) return hours + 'h ago';
                        const days = Math.floor(hours / 24);
                        return days + 'd ago';
                    } catch (e) { return ''; }
                }

                async function loadNotifs() {
                    try {
                        const res = await fetch('/api/notifications?hours=48', { cache: 'no-store' });
                        const data = await res.json();
                        const items = (data && data.notifications) || [];
                        list.innerHTML = '';
                        if (!items.length) {
                            const li = document.createElement('li');
                            li.className = 'px-4 py-3 text-sm text-gray-500';
                            li.textContent = 'No notifications';
                            list.appendChild(li);
                        } else {
                            items.forEach(n => {
                                const li = document.createElement('li');
                                li.className = 'px-4 py-3 hover:bg-gray-50';
                                const msg = document.createElement('div');
                                msg.className = 'text-sm text-gray-800';
                                msg.textContent = n.message || '';
                                const meta = document.createElement('div');
                                meta.className = 'text-xs text-gray-500 mt-1';
                                meta.textContent = timeAgo(n.created_at);
                                li.appendChild(msg);
                                li.appendChild(meta);
                                list.appendChild(li);
                            });
                        }
                        if (items.length > 0) {
                            badge.textContent = String(items.length);
                            badge.classList.remove('hidden');
                        } else {
                            badge.classList.add('hidden');
                        }
                    } catch (e) {
                        // ignore
                    }
                }

                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    dd.classList.toggle('hidden');
                });
                document.addEventListener('click', function () {
                    dd.classList.add('hidden');
                });

                loadNotifs();
                setInterval(loadNotifs, 60000); // refresh every minute
            })();
        </script>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal"
        class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div id="modal-content" class="bg-white rounded-lg shadow-2xl w-11/12 max-w-4xl max-h-[90vh] flex flex-col">
            <header class="flex justify-between items-center p-4 border-b">
                <h2 class="text-2xl font-bold text-blue-900">Report Preview</h2>
                <button id="modal-close-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </header>
            <main id="modal-preview-body" class="p-6 overflow-y-auto">
                <!-- Preview content will be injected here -->
            </main>
            <footer class="p-4 bg-gray-50 border-t flex justify-end gap-4">
                <button id="modal-cancel-btn" type="button"
                    class="bg-gray-200 text-gray-800 px-6 py-2 rounded-md hover:bg-gray-300 transition">Go Back &
                    Edit</button>
                <button id="modal-confirm-btn" type="button"
                    class="bg-blue-800 text-white px-6 py-2 rounded-md shadow hover:bg-blue-700 transition">Confirm &
                    Submit</button>
            </footer>
        </div>
    </div>

    <!-- Create New Activity Modal -->
    <div id="new-activity-modal"
        class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md">
            <header class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-bold text-blue-900">Create New Activity</h2>
                <button id="activity-modal-close-btn"
                    class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </header>
            <form id="new-activity-form" class="p-6 space-y-4">
                <div>
                    <label for="activity-description" class="block text-sm font-medium text-gray-700 mb-1">Activity
                        Description *</label>
                    <input type="text" id="activity-description" name="activity_description" required
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-700 focus:ring focus:ring-blue-600 focus:ring-opacity-50"
                        placeholder="Enter activity description">
                </div>
                <div>
                    <label for="activity-area" class="block text-sm font-medium text-gray-700 mb-1">Area</label>
                    <input type="text" id="activity-area" name="area"
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-700 focus:ring focus:ring-blue-600 focus:ring-opacity-50"
                        placeholder="Enter area">
                </div>
                <div>
                    <label for="activity-unit" class="block text-sm font-medium text-gray-700 mb-1">Unit</label>
                    <input type="text" id="activity-unit" name="unit"
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-700 focus:ring focus:ring-blue-600 focus:ring-opacity-50"
                        placeholder="Enter unit (e.g., Nos, Sqm, Cum)">
                </div>
                <div>
                    <label for="activity-total-qty" class="block text-sm font-medium text-gray-700 mb-1">Total
                        Quantity</label>
                    <input type="number" id="activity-total-qty" name="total_qty" min="0" step="0.01"
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-700 focus:ring focus:ring-blue-600 focus:ring-opacity-50"
                        placeholder="Enter total quantity">
                </div>
            </form>
            <footer class="p-4 bg-gray-50 border-t flex justify-end gap-4">
                <button id="activity-modal-cancel-btn" type="button"
                    class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 transition">Cancel</button>
                <button id="activity-modal-save-btn" type="button"
                    class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">Create
                    Activity</button>
            </footer>
        </div>
    </div>

    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {

            // --- Dynamic Data (loaded from API) ---
            let projects = [];
            let reportPreparers = [];
            let contractors = [];
            let siteManagers = [];
            let departments = [];
            let manpowerDesignations = [];
            let equipmentDescriptions = [];
            let activities = {}; // Project-specific activities loaded dynamically
            let previousDayData = {};
            let currentProjectContractors = []; // Store current project's contractors

            // Utility functions
            const parseDDMMYYYYToISO = (formattedDate) => {
                if (!formattedDate || !/^\d{2}\.\d{2}\.\d{4}$/.test(formattedDate)) return '';
                const [day, month, year] = formattedDate.split('.');
                return `${year}-${month}-${day}`;
            };

            const formatISOToDDMMYYYY = (isoDate) => {
                if (!isoDate || !/^\d{4}-\d{2}-\d{2}$/.test(isoDate)) return '';
                const [year, month, day] = isoDate.split('-');
                return `${day}.${month}.${year}`;
            };

            // Load data from API
            const loadData = async () => {
                try {
                    const [
                        projectsRes, preparersRes, contractorsRes, managersRes,
                        departmentsRes, manpowerRes, equipmentRes
                    ] = await Promise.all([
                        fetch('/api/projects'),
                        fetch('/api/report-preparers'),
                        fetch('/api/contractors'),
                        fetch('/api/site-managers'),
                        fetch('/api/departments'),
                        fetch('/api/manpower-designations'),
                        fetch('/api/equipment-descriptions')
                    ]);

                    projects = await projectsRes.json();
                    reportPreparers = await preparersRes.json();
                    contractors = await contractorsRes.json();
                    siteManagers = await managersRes.json();
                    departments = await departmentsRes.json();
                    manpowerDesignations = await manpowerRes.json();
                    equipmentDescriptions = await equipmentRes.json();

                    // Initialize form after data is loaded
                    initializeForm();
                } catch (error) {
                    console.error('Error loading data:', error);
                    alert('Error loading form data. Please refresh the page.');
                }
            };

            // Update section summary statistics
            const updateSectionSummary = (tbody) => {
                if (!tbody) return;

                const rows = Array.from(tbody.querySelectorAll('tr:not(.category-header)'));
                let totalPlannedQty = 0;
                let totalCumulativeAchieved = 0;
                let weightedTotal = 0;

                rows.forEach(row => {
                    const totalQtyInput = row.querySelector('.total-qty-input');
                    const cumulativeAchievedInput = row.querySelector('.cumulative-achieved-input');

                    const totalQty = parseFloat(totalQtyInput.value) || 0;
                    const cumulativeAchieved = parseFloat(cumulativeAchievedInput.value) || 0;

                    totalPlannedQty += totalQty;
                    totalCumulativeAchieved += cumulativeAchieved;
                    if (totalQty > 0) {
                        weightedTotal += cumulativeAchieved;
                    }
                });

                const overallCompletion = totalPlannedQty > 0 ? (weightedTotal * 100 / totalPlannedQty).toFixed(2) : '0.00';

                const header = tbody.closest('tbody')?.querySelector('.category-header');
                if (header) {
                    (header.querySelector('.summary-total-qty')).textContent = totalPlannedQty.toString();
                    (header.querySelector('.summary-achieved')).textContent = totalCumulativeAchieved.toString();
                    (header.querySelector('.summary-completion')).textContent = `${overallCompletion}%`;
                }
            };

            // Add a new activity row to a section
            const addWorkProgressRow = (targetBody) => {
                if (!targetBody) return;

                const categoryId = targetBody.id;
                console.log('Adding row to section:', categoryId);
                console.log('Available activities:', activities);
                console.log('Activities for this section:', activities[categoryId]);

                const predefinedActivities = activities[categoryId];
                const row = document.createElement('tr');

                const inputClasses = "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-700 focus:ring focus:ring-blue-600 focus:ring-opacity-50 text-sm p-1";
                const readonlyInputClasses = "mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-100 text-sm p-1";
                const labelClasses = "block text-xs font-medium text-gray-700";

                // Area, Unit, Total Qty should always be read-only since they're populated from selected activity
                const detailsInputClasses = readonlyInputClasses;
                const detailsReadonly = 'readonly';

                let activityCellHTML;
                // Always create dropdown for activity selection (even if empty)
                console.log('Creating dropdown for section:', categoryId, 'with', (predefinedActivities?.length || 0), 'activities');

                if (predefinedActivities && predefinedActivities.length > 0) {
                    const options = predefinedActivities.map(act => `<option value="${act.description}">${act.description}</option>`).join('');
                    activityCellHTML = `<select class="activity-select ${inputClasses}"><option value="">-- Select Activity --</option>${options}</select>`;
                } else {
                    // Create empty dropdown - activities can be added via "Add Activity" button
                    activityCellHTML = `<select class="activity-select ${inputClasses}"><option value="">-- Select Activity --</option></select>`;
                }

                row.innerHTML = `
                    <td class="p-2 border border-gray-300 align-top responsive-cell-block" data-label="Activity & Details">
                        ${activityCellHTML}
                        <div class="grid grid-cols-3 gap-2 mt-2">
                            <div>
                                <label class="${labelClasses}">Area</label>
                                <input type="text" class="area-input ${detailsInputClasses}" placeholder="Area" ${detailsReadonly}>
                            </div>
                            <div>
                                <label class="${labelClasses}">Unit</label>
                                <input type="text" class="unit-input ${detailsInputClasses}" placeholder="Unit" ${detailsReadonly}>
                            </div>
                            <div>
                                <label class="${labelClasses}">Total Qty</label>
                                <input type="number" class="total-qty-input ${detailsInputClasses}" placeholder="Total" ${detailsReadonly}>
                            </div>
                        </div>
                    </td>
                    <td class="p-2 border border-gray-300 align-top responsive-cell-block" data-label="Today's Plan">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="${labelClasses}">Planned Today</label>
                                <input type="number" placeholder="Planned" class="${inputClasses}">
                            </div>
                            <div>
                                <label class="${labelClasses}">Achieved Today</label>
                                <input type="number" placeholder="Achieved" class="${inputClasses}">
                            </div>
                        </div>
                    </td>
                    <td class="p-2 border border-gray-300 align-top responsive-cell-block" data-label="Cumulative Progress">
                         <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="${labelClasses}">Planned Cum.</label>
                                <input type="number" class="planned-cumulative-input ${readonlyInputClasses}" placeholder="Planned" readonly>
                            </div>
                            <div>
                                <label class="${labelClasses}">Achieved Cum.</label>
                                <input type="number" class="cumulative-achieved-input ${readonlyInputClasses}" placeholder="Achieved" readonly>
                            </div>
                        </div>
                        <div class="mt-2">
                            <label class="${labelClasses}">% Completion</label>
                            <input type="text" class="completion-pct-input ${readonlyInputClasses}" placeholder="0.00%" readonly>
                        </div>
                    </td>
                    <td class="p-2 border border-gray-300 text-center align-middle action-cell">
                        <button type="button" class="delete-row-btn bg-transparent border-none text-red-600 hover:text-red-800 text-xl p-1" aria-label="Delete Row">üóëÔ∏è</button>
                    </td>
                `;

                const areaInput = row.querySelector('.area-input');
                // Area will be populated when activity is selected

                targetBody.appendChild(row);
                updateSectionSummary(targetBody);
            };

            // Rebuild work progress table with project-specific sections
            const rebuildWorkProgressTable = async (projectCode) => {
                if (!projectCode || !workProgressTable) return;

                try {
                    // Get project-specific sections
                    const sectionsRes = await fetch(`/api/project-sections?project_code=${projectCode}`);
                    const sections = await sectionsRes.json();

                    console.log('Sections loaded for project:', projectCode, sections);

                    // Clear existing table body (keep header)
                    const existingBodies = workProgressTable.querySelectorAll('tbody');
                    existingBodies.forEach(tbody => tbody.remove());

                    // Create new sections based on project data
                    sections.forEach(section => {
                        const tbody = document.createElement('tbody');
                        tbody.id = section.sectionId;
                        tbody.dataset.categoryName = section.sectionName;
                        tbody.className = 'divide-y divide-gray-200';

                        tbody.innerHTML = `
                            <tr class="category-header bg-blue-200">
                                <td colspan="3" class="p-0">
                                    <div class="category-title-summary flex flex-col sm:flex-row justify-between items-center p-2 gap-2">
                                        <div class="flex items-center gap-3">
                                            <span class="font-bold text-blue-900">${section.sectionName}</span>
                                            <button type="button" class="add-new-activity-btn bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700 transition" data-target="${section.sectionId}">Add Activity</button>
                                            <button type="button" class="add-row-btn bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700 transition" data-target="${section.sectionId}">Add Row</button>
                                        </div>
                                        <span class="category-summary text-xs font-normal text-gray-700 whitespace-nowrap">
                                            (Total Qty: <span class="summary-total-qty">0</span>, 
                                             Achieved: <span class="summary-achieved">0</span>, 
                                             Completion: <span class="summary-completion">0.00%</span>)
                                        </span>
                                    </div>
                                </td>
                                <td class="border border-gray-300 text-center align-middle">
                                    <button type="button" class="delete-section-btn bg-transparent border-none text-red-600 hover:text-red-800 text-lg p-1" aria-label="Delete Section">‚ùå</button>
                                </td>
                            </tr>
                        `;

                        workProgressTable.appendChild(tbody);

                        // Add one default activity row to each section
                        addWorkProgressRow(tbody);

                        updateSectionSummary(tbody);
                    });

                    console.log('Work progress table rebuilt for project:', projectCode, 'with', sections.length, 'sections');
                } catch (error) {
                    console.error('Error rebuilding work progress table:', error);
                }
            };

            // Load project-specific sections and activities
            const loadProjectData = async (projectCode) => {
                if (!projectCode) {
                    activities = {};
                    console.log('No project code provided, clearing activities');
                    return;
                }

                try {
                    console.log('Loading project data for:', projectCode);
                    const activitiesRes = await fetch(`/api/project-activities?project_code=${projectCode}`);

                    if (!activitiesRes.ok) {
                        throw new Error(`HTTP error! status: ${activitiesRes.status}`);
                    }

                    activities = await activitiesRes.json();
                    console.log('Project activities loaded:', activities);
                    console.log('Activities keys:', Object.keys(activities));

                    // Rebuild the work progress table with project-specific sections
                    await rebuildWorkProgressTable(projectCode);
                } catch (error) {
                    console.error('Error loading project data:', error);
                    activities = {};
                }
            };

            // Check if report already exists for current project and date
            const checkExistingReport = async () => {
                const projectCode = projectCodeSelect?.value;
                const reportDate = parseDDMMYYYYToISO(dateInput?.value);

                console.log('checkExistingReport called with:', { projectCode, reportDate });

                if (!projectCode || !reportDate) {
                    console.log('Missing project code or report date, skipping check');
                    return;
                }

                try {
                    const response = await fetch(`/api/check-report-exists?project_code=${projectCode}&report_date=${reportDate}`);
                    const result = await response.json();

                    const existingReportWarning = document.getElementById('existing-report-warning');
                    const submitButton = document.getElementById('submit-report-btn');

                    if (result.exists) {
                        console.log('Existing data found for date:', result);

                        // Show warning message
                        if (!existingReportWarning) {
                            const warningDiv = document.createElement('div');
                            warningDiv.id = 'existing-report-warning';
                            warningDiv.className = 'bg-orange-100 border border-orange-400 text-orange-700 px-4 py-3 rounded mb-4';

                            if (result.report_number) {
                                warningDiv.innerHTML = `
                                    <strong>Notice:</strong> A report for this project and date already exists!<br>
                                    <strong>Report Number:</strong> ${result.report_number}<br>
                                    <strong>Submitted:</strong> ${new Date(result.submitted_at).toLocaleString()}<br>
                                    <em>The existing data has been loaded. You cannot modify or resubmit data for this date.</em>
                                `;
                            } else {
                                warningDiv.innerHTML = `
                                    <strong>Notice:</strong> Data for this project and date already exists!<br>
                                    <em>The existing cumulative values have been loaded. You cannot modify data for this date.</em>
                                `;
                            }

                            // Insert before the form
                            const form = document.querySelector('form');
                            form.parentNode.insertBefore(warningDiv, form);
                        }

                        // Load existing data into form
                        if (result.progress_data) {
                            loadExistingProgressData(result.progress_data);
                        }

                        // Disable all input fields in work progress section
                        disableWorkProgressInputs(true);

                        // Disable submit button
                        if (submitButton) {
                            console.log('Disabling submit button due to existing data');
                            submitButton.disabled = true;
                            submitButton.textContent = result.report_number ? 'Report Already Submitted' : 'Data Already Exists';
                            submitButton.className = 'bg-gray-400 text-white px-6 py-3 rounded-md cursor-not-allowed';
                            console.log('Submit button after disabling:', {
                                disabled: submitButton.disabled,
                                text: submitButton.textContent,
                                className: submitButton.className
                            });
                        }
                    } else {
                        // Remove warning if it exists
                        if (existingReportWarning) {
                            existingReportWarning.remove();
                        }

                        // Enable all input fields
                        disableWorkProgressInputs(false);

                        // Enable submit button
                        if (submitButton) {
                            submitButton.disabled = false;
                            submitButton.textContent = 'Preview & Submit Report';
                            submitButton.className = 'bg-green-600 text-white px-8 py-3 rounded-md shadow-lg hover:bg-green-700 transition-all text-lg font-semibold w-full sm:w-auto';
                        }
                    }
                } catch (error) {
                    console.error('Error checking existing report:', error);
                }
            };

            // Load existing progress data into the form
            const loadExistingProgressData = (progressData) => {
                console.log('Loading existing progress data:', progressData);

                // Find all activity rows and populate with existing data
                const activityRows = document.querySelectorAll('#work-progress-table tbody tr:not(.category-header)');

                activityRows.forEach(row => {
                    const activitySelect = row.querySelector('.activity-select') || row.querySelector('input[placeholder="Activity Description"]');
                    if (!activitySelect) return;

                    const activityDescription = activitySelect.value || activitySelect.placeholder;
                    const existingData = progressData[activityDescription];

                    if (existingData) {
                        console.log(`Loading data for activity: ${activityDescription}`, existingData);

                        // Fill in the existing values
                        const plannedTodayInput = row.querySelector('input[placeholder="Planned"]');
                        const achievedTodayInput = row.querySelector('input[placeholder="Achieved"]');
                        const plannedCumulativeInput = row.querySelector('.planned-cumulative-input');
                        const cumulativeAchievedInput = row.querySelector('.cumulative-achieved-input');
                        const completionPctInput = row.querySelector('.completion-pct-input');
                        const totalQtyInput = row.querySelector('.total-qty-input');

                        if (plannedTodayInput) plannedTodayInput.value = existingData.planned_today;
                        if (achievedTodayInput) achievedTodayInput.value = existingData.achieved_today;
                        if (plannedCumulativeInput) plannedCumulativeInput.value = existingData.planned_cumulative;
                        if (cumulativeAchievedInput) cumulativeAchievedInput.value = existingData.achieved_cumulative;

                        // Calculate completion percentage
                        const totalQty = parseFloat(totalQtyInput?.value) || 0;
                        if (totalQty > 0 && completionPctInput) {
                            const percentage = (existingData.achieved_cumulative * 100 / totalQty).toFixed(2);
                            completionPctInput.value = `${percentage}%`;
                        }
                    }
                });
            };

            // Disable or enable work progress inputs
            const disableWorkProgressInputs = (disable) => {
                const workProgressInputs = document.querySelectorAll('#work-progress-table input[placeholder="Planned"], #work-progress-table input[placeholder="Achieved"]');

                workProgressInputs.forEach(input => {
                    input.disabled = disable;
                    if (disable) {
                        input.classList.add('bg-gray-200', 'cursor-not-allowed');
                        input.title = 'Details for this date have already been filled';
                    } else {
                        input.classList.remove('bg-gray-200', 'cursor-not-allowed');
                        input.title = '';
                    }
                });

                // Also disable activity dropdowns
                const activitySelects = document.querySelectorAll('#work-progress-table .activity-select');
                activitySelects.forEach(select => {
                    select.disabled = disable;
                    if (disable) {
                        select.classList.add('bg-gray-200', 'cursor-not-allowed');
                    } else {
                        select.classList.remove('bg-gray-200', 'cursor-not-allowed');
                    }
                });

                // Disable Add Row and Add New Activity buttons
                const addRowButtons = document.querySelectorAll('.add-row-btn[data-target]');
                addRowButtons.forEach(button => {
                    button.disabled = disable;
                    if (disable) {
                        button.classList.add('bg-gray-400', 'cursor-not-allowed');
                        button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    } else {
                        button.classList.remove('bg-gray-400', 'cursor-not-allowed');
                        button.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    }
                });

                const addNewActivityButtons = document.querySelectorAll('.add-new-activity-btn[data-target]');
                addNewActivityButtons.forEach(button => {
                    button.disabled = disable;
                    if (disable) {
                        button.classList.add('bg-gray-400', 'cursor-not-allowed');
                        button.classList.remove('bg-green-600', 'hover:bg-green-700');
                    } else {
                        button.classList.remove('bg-gray-400', 'cursor-not-allowed');
                        button.classList.add('bg-green-600', 'hover:bg-green-700');
                    }
                });
            };

            // Show notification when user tries to edit existing data
            const showEditAttemptNotification = () => {
                // Remove existing notification if any
                const existingNotification = document.getElementById('edit-attempt-notification');
                if (existingNotification) {
                    existingNotification.remove();
                }

                // Create notification
                const notification = document.createElement('div');
                notification.id = 'edit-attempt-notification';
                notification.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                notification.innerHTML = `
                    <div class="flex items-center">
                        <span class="mr-2">‚ö†Ô∏è</span>
                        <span>Details for this date have already been filled!</span>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">√ó</button>
                    </div>
                `;

                document.body.appendChild(notification);

                // Auto remove after 3 seconds
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 3000);
            };

            // Check admin login status
            const checkAdminStatus = async () => {
                try {
                    const response = await fetch('/api/admin/status');
                    const status = await response.json();

                    const adminLoginBtn = document.getElementById('admin-login-btn');
                    const adminLoggedIn = document.getElementById('admin-logged-in');

                    if (status.logged_in) {
                        adminLoginBtn.style.display = 'none';
                        adminLoggedIn.style.display = 'flex';
                    } else {
                        adminLoginBtn.style.display = 'block';
                        adminLoggedIn.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error checking admin status:', error);
                }
            };

            // Load previous day's data for cumulative calculation
            const loadPreviousDayData = async () => {
                const projectCode = projectCodeSelect.value;
                const currentDate = parseDDMMYYYYToISO(dateInput.value);

                console.log('loadPreviousDayData called with:', { projectCode, currentDate });

                if (!projectCode || !currentDate) {
                    console.log('Missing project code or current date, skipping previous day data load');
                    return;
                }

                try {
                    const url = `/api/previous-day-progress?project_code=${projectCode}&current_date=${currentDate}`;
                    console.log('Fetching previous day data from:', url);

                    const response = await fetch(url);
                    console.log('Previous day data response status:', response.status);

                    if (response.ok) {
                        previousDayData = await response.json();
                        console.log('Previous day data loaded successfully:', previousDayData);
                    } else {
                        const errorText = await response.text();
                        console.log('Previous day data request failed:', response.status, errorText);
                        previousDayData = {};
                    }
                } catch (error) {
                    console.error('Error loading previous day data:', error);
                    previousDayData = {};
                }
            };

            // --- Element Selectors ---
            const projectCodeSelect = document.getElementById('project-code');
            const projectNameInput = document.getElementById('project-name');
            const projectManagerInput = document.getElementById('project-manager');
            const projectManagerClientInput = document.getElementById('project-manager-client');
            const clientInput = document.getElementById('client');
            const targetCompletionInput = document.getElementById('target-completion');
            const reportNoInput = document.getElementById('report-no');
            const dateInput = document.getElementById('date');
            const contractorInput = document.getElementById('contractor');

            const workProgressTable = document.getElementById('work-progress-table');
            const newSectionNameInput = document.getElementById('new-section-name');
            const addSectionBtn = document.getElementById('add-section-btn');

            const manpowerTable = document.getElementById('manpower-table');
            const manpowerBody = document.getElementById('manpower-body');
            const addManpowerRowBtn = document.getElementById('add-manpower-row');

            const equipmentTable = document.getElementById('equipment-table');
            const equipmentBody = document.getElementById('equipment-body');
            const addEquipmentRowBtn = document.getElementById('add-equipment-row');

            const issuesTable = document.getElementById('issues-table');
            const addIssueRowBtn = document.getElementById('add-issue-row');
            const issuesBody = document.getElementById('issues-body');

            const prepNameInput = document.getElementById('prep-name');
            const prepDesInput = document.getElementById('prep-des');
            const verNameInput = document.getElementById('ver-name');
            const verDesInput = document.getElementById('ver-des');
            const initContractorNameSelect = document.getElementById('init-contractor-name');

            // --- Functions ---
            const initializeForm = () => {
                const setFieldValidity = (element, isValid) => {
                    if (!element) return;
                    if (isValid) {
                        element.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                    } else {
                        element.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                    }
                };

                const validateForm = () => {
                    const requiredFields = [
                        { id: 'project-code', name: 'Project Code' },
                        { id: 'prep-name', name: 'Prepared By Name' },
                        { id: 'init-contractor-name', name: 'Initiated by Contractor Name' },
                        { id: 'init-name', name: 'Initiated by Representative Name' },
                        { id: 'ver-name', name: 'Verified By Name' },
                    ];

                    requiredFields.forEach(field => {
                        const element = document.getElementById(field.id);
                        setFieldValidity(element, true);
                    });

                    let allValid = true;
                    const missingFields = [];

                    requiredFields.forEach(field => {
                        const element = document.getElementById(field.id);
                        if (!element || !element.value.trim()) {
                            allValid = false;
                            missingFields.push(field.name);
                            setFieldValidity(element, false);
                        }
                    });

                    if (!allValid) {
                        alert(`Please fill out all required fields:\n- ${missingFields.join('\n- ')}`);
                    }

                    return allValid;
                };

                const formatDateToDDMMYYYY = (isoDate) => {
                    if (!isoDate || !/^\d{4}-\d{2}-\d{2}$/.test(isoDate)) return '';
                    const [year, month, day] = isoDate.split('-');
                    return `${day}.${month}.${year}`;
                };

                const parseDDMMYYYYToISO = (formattedDate) => {
                    if (!formattedDate || !/^\d{2}\.\d{2}\.\d{4}$/.test(formattedDate)) return '';
                    const [day, month, year] = formattedDate.split('.');
                    return `${year}-${month}-${day}`;
                };

                const populateProjectDropdown = () => {
                    if (!projectCodeSelect) return;
                    projects.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.code;
                        option.textContent = `${p.code} - ${p.name}`;
                        projectCodeSelect.appendChild(option);
                    });
                };

                const populateSignatureDropdowns = () => {
                    // This function is now only called on initial page load
                    // Project-specific signature dropdowns are populated by loadProjectSpecificStaff()

                    // Initialize with empty dropdowns
                    const prepNameSelect = document.getElementById('prep-name');
                    if (prepNameSelect) {
                        prepNameSelect.innerHTML = '<option value="">-- Select Preparer --</option>';
                    }

                    const initContractorSelect = document.getElementById('init-contractor-name');
                    if (initContractorSelect) {
                        initContractorSelect.innerHTML = '<option value="">-- Select Contractor --</option>';
                    }

                    const verNameSelect = document.getElementById('ver-name');
                    if (verNameSelect) {
                        verNameSelect.innerHTML = '<option value="">-- Select Site Manager --</option>';
                    }
                };

                const updateReportDetails = async () => {
                    const selectedCode = projectCodeSelect.value;
                    const selectedProject = projects.find(p => p.code === selectedCode);

                    if (selectedProject) {
                        projectNameInput.value = selectedProject.name;
                        projectManagerInput.value = selectedProject.manager;
                        projectManagerClientInput.value = selectedProject.projectManagerClient;
                        clientInput.value = selectedProject.client;
                        contractorInput.value = selectedProject.contractor;
                        targetCompletionInput.value = formatDateToDDMMYYYY(selectedProject.targetCompletion);
                    } else {
                        projectNameInput.value = '';
                        projectManagerInput.value = '';
                        projectManagerClientInput.value = '';
                        clientInput.value = '';
                        contractorInput.value = '';
                        targetCompletionInput.value = '';
                    }

                    const dateValue = dateInput.value;
                    if (selectedProject && dateValue) {
                        const isoDate = parseDDMMYYYYToISO(dateValue);
                        if (isoDate) {
                            const dateParts = isoDate.split('-');
                            const formattedDate = dateParts[2] + dateParts[1] + dateParts[0];
                            reportNoInput.value = `SIL-DPR-${selectedProject.reportIdFragment}-${formattedDate}`;
                        } else {
                            reportNoInput.value = '';
                        }
                    } else {
                        reportNoInput.value = '';
                    }

                    const allAreaInputs = document.querySelectorAll('#work-progress-table .area-input');
                    allAreaInputs.forEach(input => {
                        input.value = projectNameInput.value;
                    });

                    // Load previous day data for cumulative calculations
                    loadPreviousDayData();

                    // Load project-specific sections and activities
                    loadProjectData(selectedCode);

                    // Load project-specific staff (contractors, preparers, managers)
                    if (selectedCode) {
                        await loadProjectSpecificStaff(selectedCode);
                    }

                    // Check if report already exists for this project and date
                    checkExistingReport();
                };

                // Load project-specific staff (contractors, preparers, managers)
                const loadProjectSpecificStaff = async (projectCode) => {
                    try {
                        const [preparersRes, contractorsRes, managersRes] = await Promise.all([
                            fetch(`/api/report-preparers?project_code=${projectCode}`),
                            fetch(`/api/contractors?project_code=${projectCode}`),
                            fetch(`/api/site-managers?project_code=${projectCode}`)
                        ]);

                        const projectPreparers = await preparersRes.json();
                        const projectContractors = await contractorsRes.json();
                        const projectManagers = await managersRes.json();

                        // Store current project's contractors for use in manpower/equipment sections
                        currentProjectContractors = projectContractors;

                        // Update Prepared By dropdown
                        const prepNameSelect = document.getElementById('prep-name');
                        if (prepNameSelect) {
                            prepNameSelect.innerHTML = '<option value="">-- Select Preparer --</option>';
                            projectPreparers.forEach(preparer => {
                                const option = document.createElement('option');
                                option.value = preparer.name;
                                option.textContent = preparer.name;
                                option.dataset.designation = preparer.designation;
                                prepNameSelect.appendChild(option);
                            });
                        }

                        // Update Initiated by Contractor multi-select
                        const initContractorDropdown = document.getElementById('init-contractor-dropdown');
                        if (initContractorDropdown) {
                            initContractorDropdown.innerHTML = '';
                            projectContractors.forEach(contractor => {
                                const optionDiv = document.createElement('div');
                                optionDiv.className = 'flex items-center px-3 py-2 hover:bg-blue-50 cursor-pointer';
                                optionDiv.innerHTML = `
                                    <input type="checkbox" 
                                           class="contractor-checkbox mr-2" 
                                           value="${contractor.name}" 
                                           id="contractor-${contractor.name.replace(/\s+/g, '-')}"
                                           data-contact-person="${contractor.contact_person || ''}"
                                           data-contact-details="${contractor.contact_details || ''}">
                                    <label for="contractor-${contractor.name.replace(/\s+/g, '-')}" 
                                           class="cursor-pointer flex-1">${contractor.name}</label>
                                `;
                                initContractorDropdown.appendChild(optionDiv);
                            });
                            // Initialize multi-select handlers
                            initializeContractorMultiSelect();
                        }

                        // Update Verified By dropdown  
                        const verNameSelect = document.getElementById('ver-name');
                        if (verNameSelect) {
                            verNameSelect.innerHTML = '<option value="">-- Select Site Manager --</option>';
                            projectManagers.forEach(manager => {
                                const option = document.createElement('option');
                                option.value = manager.name;
                                option.textContent = manager.name;
                                option.dataset.designation = manager.designation;
                                verNameSelect.appendChild(option);
                            });
                        }

                        console.log('Project-specific staff loaded:', {
                            preparers: projectPreparers.length,
                            contractors: projectContractors.length,
                            managers: projectManagers.length
                        });

                        // Update existing contractor dropdowns in manpower and equipment tables
                        updateExistingContractorDropdowns();

                    } catch (error) {
                        console.error('Error loading project-specific staff:', error);
                    }
                };

                // Update existing contractor dropdowns in manpower and equipment tables
                const updateExistingContractorDropdowns = () => {
                    // Update manpower table contractor dropdowns
                    const manpowerContractorSelects = document.querySelectorAll('#manpower-body select');
                    manpowerContractorSelects.forEach(select => {
                        // Check if this is a contractor dropdown (look for "Select Contractor" option)
                        const firstOption = select.querySelector('option');
                        if (firstOption && firstOption.textContent.includes('Select Contractor')) {
                            updateContractorDropdown(select);
                        }
                    });

                    // Update equipment table contractor dropdowns
                    const equipmentContractorSelects = document.querySelectorAll('#equipment-body select');
                    equipmentContractorSelects.forEach(select => {
                        // Check if this is a contractor dropdown (look for "Select Contractor" option)
                        const firstOption = select.querySelector('option');
                        if (firstOption && firstOption.textContent.includes('Select Contractor')) {
                            updateContractorDropdown(select);
                        }
                    });
                };

                // Update a specific contractor dropdown with current project's contractors
                const updateContractorDropdown = (selectElement) => {
                    const currentValue = selectElement.value;
                    selectElement.innerHTML = '<option value="">-- Select Contractor --</option>';

                    console.log('Updating contractor dropdown with', currentProjectContractors.length, 'contractors');

                    currentProjectContractors.forEach(contractor => {
                        const option = document.createElement('option');
                        option.value = contractor.name;
                        option.textContent = contractor.name;
                        selectElement.appendChild(option);
                    });

                    // Restore previous selection if it still exists
                    if (currentValue && currentProjectContractors.some(c => c.name === currentValue)) {
                        selectElement.value = currentValue;
                    }
                };

                // Initialize contractor multi-select component
                const initializeContractorMultiSelect = () => {
                    const multiSelectContainer = document.getElementById('init-contractor-multi-select');

                    // Prevent duplicate initialization
                    if (!multiSelectContainer || multiSelectContainer.dataset.initialized === 'true') {
                        return;
                    }
                    multiSelectContainer.dataset.initialized = 'true';

                    const dropdown = document.getElementById('init-contractor-dropdown');
                    const chipsContainer = document.getElementById('init-contractor-chips');
                    const placeholder = document.getElementById('init-contractor-placeholder');
                    const hiddenInput = document.getElementById('init-contractor-name');

                    let selectedContractors = [];

                    // Toggle dropdown on container click
                    multiSelectContainer.addEventListener('click', (e) => {
                        e.stopPropagation();
                        dropdown.classList.toggle('hidden');
                    });

                    // Close dropdown when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!multiSelectContainer?.contains(e.target) && !dropdown?.contains(e.target)) {
                            dropdown?.classList.add('hidden');
                        }
                    });

                    // Handle checkbox changes
                    dropdown?.addEventListener('change', (e) => {
                        if (e.target.classList.contains('contractor-checkbox')) {
                            const contractorName = e.target.value;

                            if (e.target.checked) {
                                // Add contractor
                                if (!selectedContractors.includes(contractorName)) {
                                    selectedContractors.push(contractorName);
                                    addChip(contractorName);
                                }
                            } else {
                                // Remove contractor
                                selectedContractors = selectedContractors.filter(c => c !== contractorName);
                                removeChip(contractorName);
                            }

                            updateHiddenInput();
                            updatePlaceholder();
                        }
                    });

                    // Add a chip to the container
                    const addChip = (contractorName) => {
                        const chip = document.createElement('div');
                        chip.className = 'inline-flex items-center gap-1 bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm';
                        chip.dataset.contractor = contractorName;
                        chip.innerHTML = `
                            <span>${contractorName}</span>
                            <button type="button" class="remove-chip hover:text-blue-900 font-bold" data-contractor="${contractorName}">√ó</button>
                        `;
                        chipsContainer?.appendChild(chip);
                    };

                    // Remove a chip from the container
                    const removeChip = (contractorName) => {
                        const chip = chipsContainer?.querySelector(`[data-contractor="${contractorName}"]`);
                        chip?.remove();
                    };

                    // Handle chip removal clicks
                    chipsContainer?.addEventListener('click', (e) => {
                        if (e.target.classList.contains('remove-chip')) {
                            e.stopPropagation();
                            const contractorName = e.target.dataset.contractor;

                            // Uncheck the checkbox
                            const checkbox = dropdown?.querySelector(`input[value="${contractorName}"]`);
                            if (checkbox) checkbox.checked = false;

                            // Remove from selected array
                            selectedContractors = selectedContractors.filter(c => c !== contractorName);
                            removeChip(contractorName);
                            updateHiddenInput();
                            updatePlaceholder();
                        }
                    });

                    // Update the hidden input with comma-separated values
                    const updateHiddenInput = () => {
                        if (hiddenInput) {
                            hiddenInput.value = selectedContractors.join(', ');
                        }
                    };

                    // Show/hide placeholder based on selection
                    const updatePlaceholder = () => {
                        if (placeholder) {
                            placeholder.style.display = selectedContractors.length > 0 ? 'none' : 'block';
                        }
                    };
                };


                const calculateCumulative = (row) => {
                    const activitySelect = row.querySelector('.activity-select') || row.querySelector('input[placeholder="Activity Description"]');
                    const plannedTodayInput = row.querySelector('input[placeholder="Planned"]');
                    const achievedTodayInput = row.querySelector('input[placeholder="Achieved"]');
                    const plannedCumulativeInput = row.querySelector('.planned-cumulative-input');
                    const cumulativeAchievedInput = row.querySelector('.cumulative-achieved-input');
                    const completionPctInput = row.querySelector('.completion-pct-input');
                    const totalQtyInput = row.querySelector('.total-qty-input');

                    console.log('calculateCumulative called for row:', row);
                    console.log('Found elements:', {
                        activitySelect: !!activitySelect,
                        plannedTodayInput: !!plannedTodayInput,
                        achievedTodayInput: !!achievedTodayInput,
                        plannedCumulativeInput: !!plannedCumulativeInput,
                        cumulativeAchievedInput: !!cumulativeAchievedInput
                    });

                    if (!activitySelect || !plannedTodayInput || !achievedTodayInput) {
                        console.log('Missing required elements, exiting calculateCumulative');
                        return;
                    }

                    const activityDescription = activitySelect.value || activitySelect.placeholder;
                    const plannedToday = parseFloat(plannedTodayInput.value) || 0;
                    const achievedToday = parseFloat(achievedTodayInput.value) || 0;
                    const totalQty = parseFloat(totalQtyInput.value) || 0;

                    console.log('Activity values:', {
                        activityDescription,
                        plannedToday,
                        achievedToday,
                        totalQty
                    });

                    // Get previous day's cumulative values
                    const previousData = previousDayData[activityDescription] || { planned_cumulative: 0, achieved_cumulative: 0 };
                    console.log('Previous day data for', activityDescription, ':', previousData);

                    // Calculate new cumulative values
                    const plannedCumulative = previousData.planned_cumulative + plannedToday;
                    const achievedCumulative = previousData.achieved_cumulative + achievedToday;

                    console.log('Calculated cumulative values:', {
                        plannedCumulative,
                        achievedCumulative
                    });

                    // Update cumulative fields
                    if (plannedCumulativeInput) plannedCumulativeInput.value = plannedCumulative;
                    if (cumulativeAchievedInput) cumulativeAchievedInput.value = achievedCumulative;

                    // Calculate completion percentage
                    if (totalQty > 0) {
                        const percentage = (achievedCumulative * 100 / totalQty).toFixed(2);
                        if (completionPctInput) completionPctInput.value = `${percentage}%`;
                    } else {
                        if (completionPctInput) completionPctInput.value = '0.00%';
                    }

                    const tbody = row.closest('tbody');
                    if (tbody) {
                        updateSectionSummary(tbody);
                    }
                };


                let isAddingSectionInProgress = false;

                const addNewWorkSection = async () => {
                    const name = newSectionNameInput.value.trim();
                    console.log('addNewWorkSection called with name:', name);
                    if (!name || !workProgressTable) return;

                    // Prevent multiple simultaneous calls
                    if (isAddingSectionInProgress) {
                        console.log('Section addition already in progress, ignoring duplicate call');
                        return;
                    }
                    isAddingSectionInProgress = true;

                    const projectCode = projectCodeSelect?.value;
                    if (!projectCode) {
                        alert('Please select a project first');
                        isAddingSectionInProgress = false;
                        return;
                    }

                    // Disable the button to prevent double-clicks
                    const addButton = document.getElementById('add-section-btn');
                    if (addButton) {
                        addButton.disabled = true;
                        addButton.textContent = 'Adding...';
                    }

                    try {
                        // Save section to database first
                        const response = await fetch('/api/add-project-section', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                project_code: projectCode,
                                section_name: name
                            })
                        });

                        const result = await response.json();

                        if (!result.success) {
                            if (result.error === 'Section already exists') {
                                alert(`Section "${name}" already exists for this project`);
                            } else {
                                alert(`Error adding section: ${result.error}`);
                            }
                            return;
                        }

                        console.log('Section saved to database:', result);

                        // Create section in UI
                        const sectionId = name.replace(/\s+/g, '-').toLowerCase() + '-' + Date.now();

                        const tbody = document.createElement('tbody');
                        tbody.id = sectionId;
                        tbody.dataset.categoryName = name;
                        tbody.dataset.sectionId = result.section_id; // Store database ID

                        // Initialize empty activities array for this new section
                        activities[sectionId] = [];
                        tbody.innerHTML = `
                        <tr class="category-header bg-blue-200">
                            <td colspan="3" class="p-0">
                                 <div class="category-title-summary flex flex-col sm:flex-row justify-between items-center p-2 gap-2">
                                    <div class="flex items-center gap-3">
                                    <span class="font-bold text-blue-900">${name}</span>
                                        <button type="button" class="add-new-activity-btn bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700 transition" data-target="${sectionId}">Add Activity</button>
                                        <button type="button" class="add-row-btn bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700 transition" data-target="${sectionId}">Add Row</button>
                                    </div>
                                    <span class="category-summary text-xs font-normal text-gray-700 whitespace-nowrap">
                                        (Total Qty: <span class="summary-total-qty">0</span>, 
                                         Achieved: <span class="summary-achieved">0</span>, 
                                         Completion: <span class="summary-completion">0.00%</span>)
                                    </span>
                                </div>
                            </td>
                            <td class="border border-gray-300 text-center align-middle">
                                <button type="button" class="delete-section-btn bg-transparent border-none text-red-600 hover:text-red-800 text-lg p-1" aria-label="Delete Section">‚ùå</button>
                            </td>
                        </tr>
                    `;
                        workProgressTable.appendChild(tbody);

                        // Add one default activity row to the new section
                        addWorkProgressRow(tbody);

                        newSectionNameInput.value = '';

                        // Show success message
                        console.log(`Section "${name}" added successfully and saved to database`);

                    } catch (error) {
                        console.error('Error adding section:', error);
                        alert('Error adding section. Please try again.');
                    } finally {
                        // Re-enable the button and reset the flag
                        const addButton = document.getElementById('add-section-btn');
                        if (addButton) {
                            addButton.disabled = false;
                            addButton.textContent = 'Add Section';
                        }
                        isAddingSectionInProgress = false;
                    }
                };

                const handleWorkProgressInteraction = (e) => {
                    const target = e.target;
                    const row = target.closest('tr');
                    const tbody = target.closest('tbody');

                    if (target.closest('.delete-row-btn')) {
                        row?.remove();
                        if (tbody) updateSectionSummary(tbody);
                        return;
                    }

                    if (target.closest('.delete-section-btn')) {
                        if (tbody) {
                            document.querySelector(`.add-row-btn[data-target="${tbody.id}"]`)?.remove();
                            tbody.remove();
                        }
                        return;
                    }

                    if (target.classList.contains('activity-select')) {
                        const select = target;
                        const categoryId = tbody?.id;
                        if (!row || !categoryId) return;

                        const activityData = activities[categoryId]?.find(a => a.description === select.value);

                        const areaInput = row.querySelector('.area-input');
                        const unitInput = row.querySelector('.unit-input');
                        const totalQtyInput = row.querySelector('.total-qty-input');

                        if (activityData) {
                            areaInput.value = activityData.area || '';
                            unitInput.value = activityData.unit;
                            totalQtyInput.value = activityData.totalQty.toString();
                        } else {
                            areaInput.value = '';
                            unitInput.value = '';
                            totalQtyInput.value = '';
                        }
                        console.log('Activity selected, triggering cumulative calculation');
                        calculateCumulative(row);
                    }

                    // Planned/Achieved input handling moved to dedicated input event listener
                };

                const handleTableClick = (e, tableBody) => {
                    if (!tableBody) return;
                    const target = e.target;
                    if (target.closest('.delete-row-btn')) {
                        const row = target.closest('tr');
                        row?.remove();
                    }
                };

                const createSelectWithOptions = (options, defaultOptionText, cssClasses) => {
                    const select = document.createElement('select');
                    select.className = cssClasses;
                    let optionsHTML = `<option value="">-- ${defaultOptionText} --</option>`;

                    // Handle both arrays of strings and arrays of objects
                    if (options.length > 0) {
                        if (typeof options[0] === 'string') {
                            // Array of strings
                            optionsHTML += options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                        } else if (typeof options[0] === 'object' && options[0].name) {
                            // Array of objects with 'name' property (like contractors)
                            optionsHTML += options.map(opt => `<option value="${opt.name}">${opt.name}</option>`).join('');
                        } else {
                            // Fallback for other object structures
                            optionsHTML += options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                        }
                    }

                    select.innerHTML = optionsHTML;
                    return select;
                };

                // Get contractors for the currently selected project
                const getCurrentProjectContractors = () => {
                    return currentProjectContractors || [];
                };

                const addManpowerRow = () => {
                    if (!manpowerBody) return;
                    const row = document.createElement('tr');
                    const inputClasses = "w-full border-none focus:ring-0 bg-transparent p-1";
                    const tdClasses = "border border-gray-300 p-1";

                    const designationSelect = createSelectWithOptions(manpowerDesignations, 'Select Designation', inputClasses);
                    const typeSelect = createSelectWithOptions(['Direct', 'Indirect'], 'Select Type', inputClasses);
                    const departmentSelect = createSelectWithOptions(departments, 'Select Dept', inputClasses);
                    const contractorSelect = createSelectWithOptions(getCurrentProjectContractors(), 'Select Contractor', inputClasses);

                    row.innerHTML = `
                    <td class="${tdClasses}" data-label="Designation"></td>
                    <td class="${tdClasses}" data-label="No. of Manpower"><input type="number" placeholder="No." class="${inputClasses}"></td>
                    <td class="${tdClasses}" data-label="Type"></td>
                    <td class="${tdClasses}" data-label="Department"></td>
                    <td class="${tdClasses}" data-label="Contractor"></td>
                    <td class="border border-gray-300 text-center action-cell"><button type="button" class="delete-row-btn bg-transparent border-none text-red-600 hover:text-red-800 text-xl p-1" aria-label="Delete Row">üóëÔ∏è</button></td>
                `;
                    row.cells[0].appendChild(designationSelect);
                    row.cells[2].appendChild(typeSelect);
                    row.cells[3].appendChild(departmentSelect);
                    row.cells[4].appendChild(contractorSelect);
                    manpowerBody.appendChild(row);
                };

                const addEquipmentRow = () => {
                    if (!equipmentBody) return;
                    const row = document.createElement('tr');
                    const inputClasses = "w-full border-none focus:ring-0 bg-transparent p-1";
                    const tdClasses = "border border-gray-300 p-1";

                    const equipmentSelect = createSelectWithOptions(equipmentDescriptions, 'Select Equipment', inputClasses);
                    const departmentSelect = createSelectWithOptions(departments, 'Select Dept', inputClasses);
                    const contractorSelect = createSelectWithOptions(getCurrentProjectContractors(), 'Select Contractor', inputClasses);

                    row.innerHTML = `
                    <td class="${tdClasses}" data-label="Description"></td>
                    <td class="${tdClasses}" data-label="No."><input type="number" placeholder="No." class="${inputClasses}"></td>
                    <td class="${tdClasses}" data-label="Effective Hrs"><input type="number" placeholder="Hrs" class="${inputClasses}"></td>
                    <td class="${tdClasses}" data-label="Idle Hrs"><input type="number" placeholder="Hrs" class="${inputClasses}"></td>
                    <td class="${tdClasses}" data-label="Department"></td>
                    <td class="${tdClasses}" data-label="Contractor"></td>
                    <td class="border border-gray-300 text-center action-cell"><button type="button" class="delete-row-btn bg-transparent border-none text-red-600 hover:text-red-800 text-xl p-1" aria-label="Delete Row">üóëÔ∏è</button></td>
                `;
                    row.cells[0].appendChild(equipmentSelect);
                    row.cells[4].appendChild(departmentSelect);
                    row.cells[5].appendChild(contractorSelect);
                    equipmentBody.appendChild(row);
                };

                const addIssueRow = () => {
                    if (!issuesBody) return;
                    const row = document.createElement('tr');
                    const inputClasses = "w-full border-none focus:ring-0 bg-transparent p-1";
                    const tdClasses = "border border-gray-300 p-1";

                    row.innerHTML = `
                    <td class="${tdClasses}" data-label="Issues"><textarea rows="1" placeholder="Describe the issue" class="${inputClasses}"></textarea></td>
                    <td class="${tdClasses}" data-label="Raised (Date)"><input type="text" placeholder="dd.mm.yyyy" class="${inputClasses}"></td>
                    <td class="${tdClasses}" data-label="Work Affected"><textarea rows="1" placeholder="Describe work affected" class="${inputClasses}"></textarea></td>
                    <td class="border border-gray-300 text-center action-cell"><button type="button" class="delete-row-btn bg-transparent border-none text-red-600 hover:text-red-800 text-xl p-1" aria-label="Delete Row">üóëÔ∏è</button></td>
                `;
                    issuesBody.appendChild(row);
                };

                // handleNameInput function removed - designation auto-population is now handled 
                // directly in the dropdown change event handlers

                // populateSelectWithOptions function removed - now using createSelectWithOptions instead

                // --- Initialization & Event Listeners ---
                if (dateInput) {
                    const today = new Date();
                    const day = String(today.getDate()).padStart(2, '0');
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const year = today.getFullYear();
                    dateInput.value = `${day}.${month}.${year}`;
                }

                populateProjectDropdown();
                populateSignatureDropdowns();

                ['concrete', 'steel', 'ctBasin', 'ibrPiperack'].forEach(sectionId => {
                    const sectionTbody = document.getElementById(sectionId);
                    if (sectionTbody) {
                        addWorkProgressRow(sectionTbody);
                    }
                });

                for (let i = 0; i < 10; i++) {
                    addManpowerRow();
                    addEquipmentRow();
                }

                document.querySelectorAll('#work-progress-table tbody').forEach(tbody => {
                    updateSectionSummary(tbody);
                });

                updateReportDetails();

                projectCodeSelect?.addEventListener('change', updateReportDetails);
                dateInput?.addEventListener('change', updateReportDetails);

                // Also check for existing reports when project or date changes
                projectCodeSelect?.addEventListener('change', () => {
                    console.log('Project changed, checking existing report');
                    checkExistingReport();
                });
                dateInput?.addEventListener('change', () => {
                    console.log('Date changed, checking existing report');
                    checkExistingReport();
                });

                // Also check when date input loses focus (in case user types date manually)
                dateInput?.addEventListener('blur', () => {
                    console.log('Date input blur, checking existing report');
                    checkExistingReport();
                });

                // Add event handlers for signature dropdowns
                document.getElementById('prep-name')?.addEventListener('change', (e) => {
                    const selectedOption = e.target.selectedOptions[0];
                    const prepDesInput = document.getElementById('prep-des');
                    if (prepDesInput && selectedOption) {
                        prepDesInput.value = selectedOption.dataset.designation || '';
                    }
                });

                document.getElementById('ver-name')?.addEventListener('change', (e) => {
                    const selectedOption = e.target.selectedOptions[0];
                    const verDesInput = document.getElementById('ver-des');
                    if (verDesInput && selectedOption) {
                        verDesInput.value = selectedOption.dataset.designation || '';
                    }
                });

                document.addEventListener('click', (e) => {
                    const target = e.target;
                    if (target.matches('.add-row-btn[data-target]')) {
                        const tbodyId = target.dataset.target;
                        if (tbodyId) {
                            const targetBody = document.getElementById(tbodyId);
                            if (targetBody) addWorkProgressRow(targetBody);
                        }
                    }
                });

                workProgressTable?.addEventListener('change', handleWorkProgressInteraction);
                workProgressTable?.addEventListener('input', handleWorkProgressInteraction);

                // Handle actual form submission logic
                const handleFormSubmission = async () => {
                    const submitButton = document.getElementById('submit-report-btn');

                    // Collect form data
                    const formData = {
                        reportNumber: reportNoInput?.value,
                        projectCode: projectCodeSelect?.value,
                        reportDate: parseDDMMYYYYToISO(dateInput?.value),
                        projectName: projectNameInput?.value,
                        // Signatories (use explicit IDs used elsewhere in preview)
                        preparedBy: `${document.getElementById('prep-name')?.value || ''}${document.getElementById('prep-des')?.value ? ' (' + document.getElementById('prep-des').value + ')' : ''}`.trim(),
                        checkedBy: document.querySelector('input[placeholder="Name of person who checked the report"]')?.value || '',
                        approvedBy: document.querySelector('input[placeholder="Name of person who approved the report"]')?.value || '',
                        initiatedByContractor: `${document.getElementById('init-contractor-name')?.value || ''}${document.getElementById('init-name')?.value ? ' - ' + document.getElementById('init-name').value : ''}${document.getElementById('init-des')?.value ? ' (' + document.getElementById('init-des').value + ')' : ''}`.trim(),
                        verifiedBy: `${document.getElementById('ver-name')?.value || ''}${document.getElementById('ver-des')?.value ? ' (' + document.getElementById('ver-des').value + ')' : ''}`.trim(),
                        // Header fields
                        projectManagerContractor: document.getElementById('project-manager')?.value || '',
                        projectManagerClient: document.getElementById('project-manager-client')?.value || '',
                        targetCompletion: document.getElementById('target-completion')?.value || '',
                        client: document.getElementById('client')?.value || '',
                        contractor: document.getElementById('contractor')?.value || '',
                        subcontractorDeployed: document.getElementById('subcontractor-deployed')?.value || '',
                        weather: {
                            max: document.querySelector('input[placeholder="Max Temp (¬∞C)"]')?.value || '',
                            min: document.querySelector('input[placeholder="Min Temp (¬∞C)"]')?.value || ''
                        }
                        // Fallback payload pieces; activities will also be saved server-side from DPR table
                    };

                    // Validate required fields
                    if (!formData.reportNumber || !formData.projectCode || !formData.reportDate) {
                        alert('Please fill in all required fields (Project, Date).');
                        return;
                    }

                    try {
                        submitButton.disabled = true;
                        submitButton.textContent = 'Submitting...';
                        // 1) Persist activity rows to daily_progress_reports so server can build authoritative payload
                        try {
                            await saveDailyProgress();
                        } catch (e) {
                            console.warn('saveDailyProgress failed or returned error:', e?.message || e);
                        }
                        // 2) Also attach activities from UI as fallback in case DPR rows are empty
                        try {
                            const fallbackActivities = [];
                            document.querySelectorAll('#work-progress-table tbody tr:not(.category-header)')
                                .forEach(row => {
                                    const activitySelect = row.querySelector('.activity-select') || row.querySelector('input[placeholder="Activity Description"]');
                                    const plannedTodayInput = row.querySelector('input[placeholder="Planned"]');
                                    const achievedTodayInput = row.querySelector('input[placeholder="Achieved"]');
                                    const plannedCumulativeInput = row.querySelector('.planned-cumulative-input');
                                    const cumulativeAchievedInput = row.querySelector('.cumulative-achieved-input');
                                    const sectionName = row.closest('tbody')?.dataset?.categoryName || '';
                                    if (activitySelect && activitySelect.value) {
                                        fallbackActivities.push({
                                            description: activitySelect.value,
                                            sectionName: sectionName,
                                            planned_today: parseFloat(plannedTodayInput?.value) || 0,
                                            achieved_today: parseFloat(achievedTodayInput?.value) || 0,
                                            planned_cumulative: parseFloat(plannedCumulativeInput?.value) || 0,
                                            achieved_cumulative: parseFloat(cumulativeAchievedInput?.value) || 0
                                        });
                                    }
                                });
                            formData.activities = fallbackActivities;
                        } catch (_) { }

                        // 3) Collect Manpower rows
                        try {
                            const mp = [];
                            document.querySelectorAll('#manpower-body tr').forEach(row => {
                                const designation = row.querySelector('td:nth-child(1) select')?.value || '';
                                const count = row.querySelector('td:nth-child(2) input')?.value || '';
                                const department = row.querySelector('td:nth-child(4) select')?.value || '';
                                const contractor = row.querySelector('td:nth-child(5) select')?.value || '';
                                if (designation || count || contractor) {
                                    mp.push({ designation, count: Number(count) || 0, department, contractor });
                                }
                            });
                            formData.manpower = mp;
                        } catch (_) { }

                        // 4) Collect Equipment rows
                        try {
                            const eq = [];
                            document.querySelectorAll('#equipment-body tr').forEach(row => {
                                const description = row.querySelector('td:nth-child(1) select')?.value || '';
                                const count = row.querySelector('td:nth-child(2) input')?.value || '';
                                const effectiveHours = row.querySelector('td:nth-child(3) input')?.value || '';
                                const idleHours = row.querySelector('td:nth-child(4) input')?.value || '';
                                const department = row.querySelector('td:nth-child(5) select')?.value || '';
                                const contractor = row.querySelector('td:nth-child(6) select')?.value || '';
                                if (description || count || contractor || effectiveHours || idleHours) {
                                    eq.push({ description, count: Number(count) || 0, effective_hours: Number(effectiveHours) || 0, idle_hours: Number(idleHours) || 0, department, contractor });
                                }
                            });
                            formData.equipment = eq;
                        } catch (_) { }

                        // 5) Concerns, Incidents, Critical Issues
                        try {
                            formData.concerns = document.getElementById('quality-concerns')?.value || '';
                            formData.mitigation = document.getElementById('mitigation')?.value || '';
                            formData.incidents = document.getElementById('safety-incident')?.value || '';
                            formData.actionAvoidance = document.getElementById('action-avoidance')?.value || '';
                            // Build critical issues summary from table rows
                            const parts = [];
                            const issueDetails = [];
                            document.querySelectorAll('#issues-body tr').forEach(row => {
                                const issue = row.querySelector('td:nth-child(1) textarea')?.value?.trim();
                                const dateRaised = row.querySelector('td:nth-child(2) input[type="text"]')?.value?.trim();
                                const affected = row.querySelector('td:nth-child(3) textarea')?.value?.trim();
                                if (issue || dateRaised || affected) {
                                    parts.push(`‚Ä¢ ${issue || '-'} | Date: ${dateRaised || '-'} | Affected: ${affected || '-'}`);
                                    issueDetails.push({ issue: issue || '', dateRaised: dateRaised || '', affected: affected || '' });
                                }
                            });
                            formData.criticalIssues = parts.join('\n'); // legacy
                            formData.criticalIssuesDetails = issueDetails; // structured
                        } catch (_) { }

                        const response = await fetch('/api/submit-report', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(formData)
                        });

                        const result = await response.json();

                        if (result.success) {
                            alert(`Report ${result.report_number} submitted successfully!`);
                            // Optionally redirect or reset form
                            location.reload();
                        } else {
                            alert(`Error: ${result.error}`);
                        }
                    } catch (error) {
                        console.error('Error submitting report:', error);
                        alert('Error submitting report. Please try again.');
                    } finally {
                        submitButton.disabled = false;
                        submitButton.textContent = 'Preview & Submit Report';
                    }
                };

                // Submit button click handler is now handled by the modal system at the bottom of the file

                // Handle form submission (legacy - keeping for compatibility)
                document.querySelector('form')?.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    console.log('Form submission attempted');
                    const submitButton = document.getElementById('submit-report-btn');
                    console.log('Submit button disabled status:', submitButton.disabled);
                    console.log('Submit button text:', submitButton.textContent);

                    // Check if submit button is disabled
                    if (submitButton.disabled) {
                        console.log('Submit button is disabled, preventing submission');
                        showEditAttemptNotification();
                        alert('Cannot submit: Data for this project and date already exists.');
                        return;
                    }

                    // Double-check for existing reports before submission
                    const projectCode = projectCodeSelect?.value;
                    const reportDate = parseDDMMYYYYToISO(dateInput?.value);

                    if (projectCode && reportDate) {
                        try {
                            const checkResponse = await fetch(`/api/check-report-exists?project_code=${projectCode}&report_date=${reportDate}`);
                            const checkResult = await checkResponse.json();

                            if (checkResult.exists) {
                                showEditAttemptNotification();
                                alert('Cannot submit: Data for this project and date already exists.');
                                return;
                            }
                        } catch (error) {
                            console.error('Error checking existing report before submission:', error);
                        }
                    }

                    // Check if any input fields are disabled (additional safety check)
                    const disabledInputs = document.querySelectorAll('#work-progress-table input[placeholder="Planned"]:disabled, #work-progress-table input[placeholder="Achieved"]:disabled');
                    if (disabledInputs.length > 0) {
                        showEditAttemptNotification();
                        alert('Cannot submit: Some fields are disabled because data already exists for this date.');
                        return;
                    }

                    // Use the shared form submission function
                    await handleFormSubmission();
                });
                workProgressTable?.addEventListener('click', handleWorkProgressInteraction);

                // Add event delegation for input changes in work progress table
                workProgressTable?.addEventListener('input', (e) => {
                    const target = e.target;
                    const row = target.closest('tr');

                    if (target.matches('input[placeholder="Planned"], input[placeholder="Achieved"]')) {
                        if (target.disabled) {
                            showEditAttemptNotification();
                            target.blur(); // Remove focus from disabled field
                            return;
                        }

                        console.log('Input detected on planned/achieved field:', target.placeholder, 'value:', target.value);
                        if (row) calculateCumulative(row);
                    }
                });

                // Add event delegation for clicks on disabled elements
                workProgressTable?.addEventListener('click', (e) => {
                    const target = e.target;

                    if (target.disabled || target.classList.contains('cursor-not-allowed')) {
                        e.preventDefault();
                        showEditAttemptNotification();
                        return false;
                    }
                });

                // Add event delegation for focus on disabled inputs
                workProgressTable?.addEventListener('focus', (e) => {
                    const target = e.target;

                    if (target.disabled) {
                        showEditAttemptNotification();
                        target.blur();
                    }
                }, true);

                // Add event delegation for activity description input (save new activities to database)
                workProgressTable?.addEventListener('blur', async (e) => {
                    const target = e.target;

                    // Check if this is an activity description input field
                    if (target.matches('input[placeholder="Activity Description"]')) {
                        const activityDescription = target.value.trim();

                        if (!activityDescription) return; // Don't save empty activities

                        const projectCode = projectCodeSelect?.value;
                        const row = target.closest('tr');
                        const tbody = target.closest('tbody');
                        const sectionName = tbody?.dataset?.categoryName;

                        if (!projectCode || !sectionName) {
                            console.log('Missing project code or section name, cannot save activity');
                            return;
                        }

                        try {
                            // Save activity to database
                            const response = await fetch('/api/add-project-activity', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    project_code: projectCode,
                                    section_name: sectionName,
                                    activity_description: activityDescription,
                                    unit: '', // Default empty, can be filled later
                                    total_qty: 0 // Default 0, can be filled later
                                })
                            });

                            const result = await response.json();

                            if (result.success) {
                                console.log('Activity saved to database:', result);

                                // Update the activity data in memory for this section
                                const categoryId = tbody?.id;
                                if (categoryId) {
                                    if (!activities[categoryId]) {
                                        activities[categoryId] = [];
                                    }

                                    // Add the new activity to the local activities data
                                    activities[categoryId].push({
                                        description: activityDescription,
                                        area: '',
                                        unit: result.unit || '',
                                        totalQty: result.total_qty || 0
                                    });

                                    console.log(`Activity "${activityDescription}" added to section "${sectionName}" and saved to database`);
                                }

                            } else if (result.error !== 'Activity already exists') {
                                // Only show error if it's not a duplicate (duplicates are expected and OK)
                                console.log('Error saving activity:', result.error);
                            }

                        } catch (error) {
                            console.error('Error saving activity to database:', error);
                        }
                    }
                });

                addSectionBtn?.addEventListener('click', addNewWorkSection);

                manpowerTable?.addEventListener('click', (e) => handleTableClick(e, manpowerBody));
                equipmentTable?.addEventListener('click', (e) => handleTableClick(e, equipmentBody));
                issuesTable?.addEventListener('click', (e) => handleTableClick(e, issuesBody));

                addManpowerRowBtn?.addEventListener('click', addManpowerRow);
                addEquipmentRowBtn?.addEventListener('click', addEquipmentRow);
                addIssueRowBtn?.addEventListener('click', addIssueRow);

                // Event listeners for signature dropdowns removed - designation auto-population 
                // is now handled by the dropdown change events in loadProjectSpecificStaff()

                // --- Modal Selectors & Logic ---
                const submitReportBtn = document.getElementById('submit-report-btn');
                const confirmationModal = document.getElementById('confirmation-modal');
                const modalPreviewBody = document.getElementById('modal-preview-body');
                const modalCloseBtn = document.getElementById('modal-close-btn');
                const modalCancelBtn = document.getElementById('modal-cancel-btn');
                const modalConfirmBtn = document.getElementById('modal-confirm-btn');

                // --- New Activity Modal ---
                const newActivityModal = document.getElementById('new-activity-modal');
                const activityModalCloseBtn = document.getElementById('activity-modal-close-btn');
                const activityModalCancelBtn = document.getElementById('activity-modal-cancel-btn');
                const activityModalSaveBtn = document.getElementById('activity-modal-save-btn');
                const newActivityForm = document.getElementById('new-activity-form');
                let currentSectionForNewActivity = null;

                const getInputValue = (id, isTextarea = false) => {
                    const element = document.getElementById(id);
                    return element?.value.trim() || 'N/A';
                };

                const getElementValue = (selector) => (document.querySelector(selector))?.value.trim() || 'N/A';

                const generatePreviewHtml = () => {
                    let html = '';

                    // Project Details
                    html += `
                    <div class="preview-section">
                        <h3>Project Information</h3>
                        <div class="preview-grid">
                            <div class="preview-item"><span class="preview-item-label">Project Name</span><span class="preview-item-value">${getInputValue('project-name')}</span></div>
                            <div class="preview-item"><span class="preview-item-label">Date</span><span class="preview-item-value">${getInputValue('date') || 'Not Set'}</span></div>
                            <div class="preview-item"><span class="preview-item-label">Report No.</span><span class="preview-item-value">${getInputValue('report-no')}</span></div>
                            <div class="preview-item"><span class="preview-item-label">Project Manager (Contractor)</span><span class="preview-item-value">${getInputValue('project-manager')}</span></div>
                            <div class="preview-item"><span class="preview-item-label">Project Manager (Client)</span><span class="preview-item-value">${getInputValue('project-manager-client')}</span></div>
                            <div class="preview-item"><span class="preview-item-label">Weather (Max/Min)</span><span class="preview-item-value">${getElementValue('input[placeholder="Max Temp (¬∞C)"]') || '?'}¬∞C / ${getElementValue('input[placeholder="Min Temp (¬∞C)"]') || '?'}¬∞C</span></div>
                            <div class="preview-item"><span class="preview-item-label">Contractor</span><span class="preview-item-value">${getInputValue('contractor')}</span></div>
                        </div>
                    </div>
                `;

                    // Work Progress Summary
                    const workProgressSections = document.querySelectorAll('#work-progress-table > tbody');
                    let workProgressHtml = '';
                    workProgressSections.forEach(tbody => {
                        const sectionName = tbody.dataset.categoryName;
                        const completion = tbody.querySelector('.summary-completion')?.textContent;
                        if (sectionName && completion) {
                            workProgressHtml += `<li class="preview-item"><strong>${sectionName}:</strong> ${completion} complete</li>`;
                        }
                    });
                    html += `
                    <div class="preview-section">
                        <h3>Work Progress Summary</h3>
                        <ul class="list-none space-y-2">${workProgressHtml || '<li>No work progress data entered.</li>'}</ul>
                    </div>
                `;

                    // Manpower Details
                    const manpowerRows = document.querySelectorAll('#manpower-body tr');
                    let manpowerHtml = '';
                    if (manpowerRows.length > 0) {
                        let hasContent = false;
                        let tableRowsHtml = '';
                        manpowerRows.forEach(row => {
                            const designation = (row.querySelector('td:nth-child(1) select'))?.value.trim();
                            const number = (row.querySelector('td:nth-child(2) input'))?.value.trim();
                            const type = (row.querySelector('td:nth-child(3) select'))?.value.trim();
                            const department = (row.querySelector('td:nth-child(4) select'))?.value.trim();
                            const contractor = (row.querySelector('td:nth-child(5) select'))?.value.trim();

                            if (designation && number) {
                                hasContent = true;
                                tableRowsHtml += `<tr>
                                <td>${designation || '-'}</td>
                                <td>${number || '-'}</td>
                                <td>${type || '-'}</td>
                                <td>${department || '-'}</td>
                                <td>${contractor || '-'}</td>
                            </tr>`;
                            }
                        });

                        if (hasContent) {
                            manpowerHtml = `<table class="preview-table"><thead><tr><th>Designation</th><th>No.</th><th>Type</th><th>Department</th><th>Contractor</th></tr></thead><tbody>${tableRowsHtml}</tbody></table>`;
                        } else {
                            manpowerHtml = '<p>No manpower data entered.</p>';
                        }
                    } else {
                        manpowerHtml = '<p>No manpower data entered.</p>';
                    }
                    html += `<div class="preview-section"><h3>Manpower Details</h3>${manpowerHtml}</div>`;

                    // Equipment Details
                    const equipmentRows = document.querySelectorAll('#equipment-body tr');
                    let equipmentHtml = '';
                    if (equipmentRows.length > 0) {
                        let hasContent = false;
                        let tableRowsHtml = '';
                        equipmentRows.forEach(row => {
                            const description = (row.querySelector('td:nth-child(1) select'))?.value.trim();
                            const no = (row.querySelector('td:nth-child(2) input'))?.value.trim();
                            const effectiveHrs = (row.querySelector('td:nth-child(3) input'))?.value.trim();
                            const idleHrs = (row.querySelector('td:nth-child(4) input'))?.value.trim();
                            const department = (row.querySelector('td:nth-child(5) select'))?.value.trim();
                            const contractor = (row.querySelector('td:nth-child(6) select'))?.value.trim();

                            if (description || no) {
                                hasContent = true;
                                tableRowsHtml += `<tr>
                                <td>${description || '-'}</td><td>${no || '-'}</td>
                                <td>${effectiveHrs || '-'}</td><td>${idleHrs || '-'}</td>
                                <td>${department || '-'}</td><td>${contractor || '-'}</td>
                            </tr>`;
                            }
                        });

                        if (hasContent) {
                            equipmentHtml = `<table class="preview-table"><thead><tr><th>Description</th><th>No.</th><th>Effective Hrs</th><th>Idle Hrs</th><th>Department</th><th>Contractor</th></tr></thead><tbody>${tableRowsHtml}</tbody></table>`;
                        } else {
                            equipmentHtml = '<p>No equipment data entered.</p>';
                        }
                    } else {
                        equipmentHtml = '<p>No equipment data entered.</p>';
                    }
                    html += `<div class="preview-section"><h3>Equipment Details</h3>${equipmentHtml}</div>`;

                    // Critical Issues
                    const issuesRows = document.querySelectorAll('#issues-body tr');
                    let issuesHtml = '';
                    if (issuesRows.length > 0) {
                        let hasContent = false;
                        let tableRowsHtml = '';
                        issuesRows.forEach(row => {
                            const issue = (row.querySelector('td:nth-child(1) textarea'))?.value.trim();
                            const date = (row.querySelector('td:nth-child(2) input[type="text"]'))?.value.trim();
                            const affected = (row.querySelector('td:nth-child(3) textarea'))?.value.trim();

                            if (issue || date || affected) {
                                hasContent = true;
                                tableRowsHtml += `<tr><td>${issue || '-'}</td><td>${date || '-'}</td><td>${affected || '-'}</td></tr>`;
                            }
                        });

                        if (hasContent) {
                            issuesHtml = `<table class="preview-table"><thead><tr><th>Issue</th><th>Date Raised</th><th>Work Affected</th></tr></thead><tbody>${tableRowsHtml}</tbody></table>`;
                        } else {
                            issuesHtml = '<p>No critical issues logged.</p>';
                        }
                    } else {
                        issuesHtml = '<p>No critical issues logged.</p>';
                    }
                    html += `<div class="preview-section"><h3>Critical Issues</h3>${issuesHtml}</div>`;

                    // Concerns & Incidents
                    html += `
                    <div class="preview-section">
                        <h3>Concerns & Incidents</h3>
                        <div class="preview-grid">
                            <div class="preview-item"><span class="preview-item-label">Quality Concerns</span><span class="preview-item-value">${getInputValue('quality-concerns', true)}</span></div>
                            <div class="preview-item"><span class="preview-item-label">Safety Incidents</span><span class="preview-item-value">${getInputValue('safety-incident', true)}</span></div>
                        </div>
                    </div>
                `;

                    // Signatories
                    html += `
                    <div class="preview-section">
                        <h3>Signatories</h3>
                        <div class="preview-grid">
                            <div class="preview-item">
                                <span class="preview-item-label">Prepared By</span>
                                <span class="preview-item-value">${getInputValue('prep-name')} (${getInputValue('prep-des') || 'N/A'})</span>
                            </div>
                            <div class="preview-item">
                                <span class="preview-item-label">Initiated by Contractor</span>
                                <span class="preview-item-value">
                                    <strong>${getInputValue('init-contractor-name') || 'N/A'}</strong><br>
                                    ${getInputValue('init-name') || 'N/A'} (${getInputValue('init-des') || 'N/A'})
                                </span>
                            </div>
                            <div class="preview-item">
                                <span class="preview-item-label">Verified by (Site Manager)</span>
                                <span class="preview-item-value">${getInputValue('ver-name')} (${getInputValue('ver-des') || 'N/A'})</span>
                            </div>
                        </div>
                    </div>
                `;

                    return html;
                };

                // --- Create New Activity Modal Functions ---
                const showNewActivityModal = (sectionId) => {
                    currentSectionForNewActivity = sectionId;
                    // Clear form
                    newActivityForm.reset();

                    // Show modal
                    newActivityModal.classList.remove('hidden');
                    // Focus on first input
                    document.getElementById('activity-description').focus();
                };

                const hideNewActivityModal = () => {
                    newActivityModal.classList.add('hidden');
                    currentSectionForNewActivity = null;
                    newActivityForm.reset();
                };

                const createNewActivity = async () => {
                    const activityDescription = document.getElementById('activity-description').value.trim();
                    const area = document.getElementById('activity-area').value.trim();
                    const unit = document.getElementById('activity-unit').value.trim();
                    const totalQty = parseFloat(document.getElementById('activity-total-qty').value) || 0;

                    if (!activityDescription) {
                        alert('Activity Description is required');
                        return;
                    }

                    if (!currentSectionForNewActivity) {
                        alert('No section selected');
                        return;
                    }

                    const projectCode = projectCodeSelect?.value;
                    const sectionElement = document.getElementById(currentSectionForNewActivity);
                    const sectionName = sectionElement?.dataset?.categoryName;

                    if (!projectCode || !sectionName) {
                        alert('Project code or section name not found');
                        return;
                    }

                    try {
                        // Disable save button during operation
                        activityModalSaveBtn.disabled = true;
                        activityModalSaveBtn.textContent = 'Creating...';

                        // Save to database
                        const response = await fetch('/api/add-project-activity', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                project_code: projectCode,
                                section_name: sectionName,
                                activity_description: activityDescription,
                                area: area,
                                unit: unit,
                                total_qty: totalQty
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            console.log('New activity created successfully:', result);

                            // Update local activities data for this specific section
                            const categoryId = currentSectionForNewActivity;
                            if (!activities[categoryId]) {
                                activities[categoryId] = [];
                            }

                            // Add the new activity to local data
                            activities[categoryId].push({
                                description: activityDescription,
                                area: area,
                                unit: unit,
                                totalQty: totalQty
                            });

                            // Update all existing dropdowns in this section
                            updateSectionActivityDropdowns(categoryId);

                            // Hide modal
                            hideNewActivityModal();

                            alert(`Activity "${activityDescription}" created successfully!`);

                        } else {
                            if (result.error === 'Activity already exists') {
                                alert(`Activity "${activityDescription}" already exists in this section`);
                            } else {
                                alert(`Error creating activity: ${result.error}`);
                            }
                        }

                    } catch (error) {
                        console.error('Error creating new activity:', error);
                        alert('Error creating activity. Please try again.');
                    } finally {
                        // Re-enable save button
                        activityModalSaveBtn.disabled = false;
                        activityModalSaveBtn.textContent = 'Create Activity';
                    }
                };

                // Function to update activity dropdowns in a specific section
                const updateSectionActivityDropdowns = (sectionId) => {
                    const sectionBody = document.getElementById(sectionId);
                    if (!sectionBody) {
                        console.log('Section body not found for:', sectionId);
                        return;
                    }

                    // Initialize activities array if it doesn't exist
                    if (!activities[sectionId]) {
                        activities[sectionId] = [];
                    }

                    // Find all activity dropdowns in this section
                    const activitySelects = sectionBody.querySelectorAll('.activity-select');
                    console.log(`Updating ${activitySelects.length} dropdowns in section ${sectionId} with ${activities[sectionId].length} activities`);

                    activitySelects.forEach(select => {
                        if (select.tagName === 'SELECT') {
                            const currentValue = select.value;

                            // Clear and repopulate options
                            select.innerHTML = '<option value="">-- Select Activity --</option>';

                            // Add activities if any exist
                            activities[sectionId].forEach(activity => {
                                const option = document.createElement('option');
                                option.value = activity.description;
                                option.textContent = activity.description;
                                option.dataset.area = activity.area || '';
                                option.dataset.unit = activity.unit || '';
                                option.dataset.totalQty = activity.totalQty || 0;
                                select.appendChild(option);
                            });

                            // Restore previous selection if it still exists
                            if (currentValue && activities[sectionId].find(a => a.description === currentValue)) {
                                select.value = currentValue;
                            }
                        }
                    });
                };

                const showConfirmationModal = async (e) => {
                    e.preventDefault();

                    console.log('Preview & Submit button clicked');
                    const submitButton = document.getElementById('submit-report-btn');

                    // Check if submit button is disabled
                    if (submitButton.disabled) {
                        console.log('Submit button is disabled, preventing preview');
                        showEditAttemptNotification();
                        alert('Cannot submit: Data for this project and date already exists.');
                        return;
                    }

                    // Double-check for existing reports before showing preview
                    const projectCode = projectCodeSelect?.value;
                    const reportDate = parseDDMMYYYYToISO(dateInput?.value);

                    if (projectCode && reportDate) {
                        try {
                            const checkResponse = await fetch(`/api/check-report-exists?project_code=${projectCode}&report_date=${reportDate}`);
                            const checkResult = await checkResponse.json();

                            if (checkResult.exists) {
                                showEditAttemptNotification();
                                alert('Cannot submit: Data for this project and date already exists.');
                                return;
                            }
                        } catch (error) {
                            console.error('Error checking existing report before preview:', error);
                        }
                    }

                    // Check if any input fields are disabled (additional safety check)
                    const disabledInputs = document.querySelectorAll('#work-progress-table input[placeholder="Planned"]:disabled, #work-progress-table input[placeholder="Achieved"]:disabled');
                    if (disabledInputs.length > 0) {
                        showEditAttemptNotification();
                        alert('Cannot submit: Some fields are disabled because data already exists for this date.');
                        return;
                    }

                    // Validate form before showing preview
                    if (!validateForm()) {
                        return;
                    }

                    // Show the preview modal
                    modalPreviewBody.innerHTML = generatePreviewHtml();
                    confirmationModal.classList.remove('hidden');
                };

                const hideConfirmationModal = () => {
                    confirmationModal.classList.add('hidden');
                };

                const submitAndClose = async () => {
                    try {
                        console.log('User confirmed submission, proceeding with form submission');

                        // Hide modal first
                        hideConfirmationModal();

                        // Use the proper form submission logic
                        await handleFormSubmission();

                        // Success is handled by handleFormSubmission (page reload)
                    } catch (error) {
                        console.error('Error submitting report:', error);
                        alert('Error submitting report. Please try again.');
                    }
                };

                const saveDailyProgress = async () => {
                    const projectCode = projectCodeSelect.value;
                    const reportDate = parseDDMMYYYYToISO(dateInput.value);

                    if (!projectCode || !reportDate) {
                        throw new Error('Project code and date are required');
                    }

                    const activities = [];

                    // Collect data from all work progress rows
                    document.querySelectorAll('#work-progress-table tbody tr:not(.category-header)').forEach(row => {
                        const activitySelect = row.querySelector('.activity-select') || row.querySelector('input[placeholder="Activity Description"]');
                        const plannedTodayInput = row.querySelector('input[placeholder="Planned"]');
                        const achievedTodayInput = row.querySelector('input[placeholder="Achieved"]');
                        const plannedCumulativeInput = row.querySelector('.planned-cumulative-input');
                        const cumulativeAchievedInput = row.querySelector('.cumulative-achieved-input');

                        if (activitySelect && activitySelect.value) {
                            activities.push({
                                description: activitySelect.value,
                                planned_today: parseFloat(plannedTodayInput.value) || 0,
                                achieved_today: parseFloat(achievedTodayInput.value) || 0,
                                planned_cumulative: parseFloat(plannedCumulativeInput.value) || 0,
                                achieved_cumulative: parseFloat(cumulativeAchievedInput.value) || 0
                            });
                        }
                    });

                    const response = await fetch('/api/save-daily-progress', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            project_code: projectCode,
                            report_date: reportDate,
                            activities: activities
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to save progress');
                    }
                };

                submitReportBtn?.addEventListener('click', showConfirmationModal);
                modalCloseBtn?.addEventListener('click', hideConfirmationModal);
                modalCancelBtn?.addEventListener('click', hideConfirmationModal);
                modalConfirmBtn?.addEventListener('click', submitAndClose);
                confirmationModal?.addEventListener('click', (e) => {
                    if (e.target === confirmationModal) {
                        hideConfirmationModal();
                    }
                });

                // Create New Activity Modal Event Listeners
                activityModalCloseBtn?.addEventListener('click', hideNewActivityModal);
                activityModalCancelBtn?.addEventListener('click', hideNewActivityModal);
                activityModalSaveBtn?.addEventListener('click', createNewActivity);
                newActivityModal?.addEventListener('click', (e) => {
                    if (e.target === newActivityModal) {
                        hideNewActivityModal();
                    }
                });

                // Add New Activity button event listener
                document.addEventListener('click', (e) => {
                    if (e.target.matches('.add-new-activity-btn[data-target]')) {
                        const sectionId = e.target.dataset.target;
                        if (sectionId) {
                            showNewActivityModal(sectionId);
                        }
                    }
                });
            }; // End of initializeForm function

            // Initialize the application
            loadData();
            checkAdminStatus();
        });
    </script>
</body>

</html>
