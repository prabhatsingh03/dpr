<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Reports - DPR Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            .no-print {
                display: none !important;
            }

            nav {
                display: none !important;
            }

            body {
                background: white;
            }
        }

        /* Help html2pdf with page breaks */
        .avoid-break {
            break-inside: avoid;
            page-break-inside: avoid;
        }

        table {
            page-break-inside: auto;
        }

        tr,
        td,
        th,
        h2,
        h3 {
            page-break-inside: avoid !important;
            break-inside: avoid !important;
        }

        .page-break {
            page-break-before: always;
            break-before: page;
        }

        /* Compact adjustments applied to the cloned node for PDF only */
        .pdf-compact table th,
        .pdf-compact table td {
            padding: 3px 5px !important;
            font-size: 11px !important;
        }

        .pdf-compact h2 {
            font-size: 18px !important;
        }

        .pdf-compact h3 {
            font-size: 13px !important;
        }

        .pdf-compact .text-lg {
            font-size: 13px !important;
        }

        .pdf-compact .text-base {
            font-size: 12px !important;
        }

        .pdf-compact .text-sm {
            font-size: 11px !important;
        }

        /* Tighten common Tailwind paddings inside PDF only */
        .pdf-compact .px-4 {
            padding-left: 6px !important;
            padding-right: 6px !important;
        }

        .pdf-compact .py-3 {
            padding-top: 6px !important;
            padding-bottom: 6px !important;
        }

        .pdf-compact .p-8 {
            padding: 16px !important;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script>
        // Helper to read reports JSON embedded in the page
        function getReports() {
            try {
                const el = document.getElementById('reports-json');
                return JSON.parse(el?.textContent || '[]');
            } catch (_) { return []; }
        }
        function applyFilters() {
            const project = document.getElementById('project').value;
            const date = document.getElementById('report_date').value;
            const params = new URLSearchParams();
            if (project) params.set('project_code', project);
            if (date) params.set('report_date', date);
            window.location.search = params.toString();
        }
        function printReport() { window.print(); }
        async function downloadClientPDF() {
            const root = document.getElementById('reports-root');
            if (!root) return;
            // Clone root to control width and ignore elements
            const clone = root.cloneNode(true);
            clone.classList.remove('p-6');       // remove Tailwind padding from reports-root
            clone.style.padding = '0';           // ensure no bottom padding
            clone.style.paddingBottom = '0';
            // Size clone to actual content width to avoid cutting/shrinking
            const contentWidth = Math.max(794, root.scrollWidth, root.offsetWidth);
            clone.style.width = contentWidth + 'px';
            clone.style.maxWidth = contentWidth + 'px';
            clone.style.margin = '0'; // Fixed: '0 auto' caused right shift
            clone.style.overflow = 'visible';
            // Slightly compact fonts/paddings for PDF to fit more content per page
            // clone.classList.add('pdf-compact'); // Removed to allow multi-page spanning as per user request
            // Ensure elements marked with data-html2pdf-ignore are removed in clone
            clone.querySelectorAll('[data-html2pdf-ignore]')?.forEach(el => el.remove());

            // Remove shadows from the PDF clone to avoid "shade" artifacts
            clone.classList.remove('shadow-lg', 'shadow');
            clone.querySelectorAll('.shadow-lg, .shadow').forEach(el => el.classList.remove('shadow-lg', 'shadow'));
            document.body.appendChild(clone);

            const projSel = document.getElementById('project');
            const dateSel = document.getElementById('report_date');
            const proj = projSel?.value || 'All';
            // Format date as DD-MM-YYYY for filename
            const rawDate = dateSel?.value || new Date().toISOString().slice(0, 10);
            const dateParts = rawDate.split('-');
            const formattedDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;

            const A4W_PX_PORTRAIT = 794;  // ~ 210mm at 96dpi
            const A4W_PX_LANDSCAPE = 1123; // ~ 297mm at 96dpi
            let orientation = 'portrait';
            let targetWidth = A4W_PX_PORTRAIT;
            const extraDownscale = 0.92; // shrink slightly more to ensure no clipping
            const scaleToFit = Math.min((targetWidth / contentWidth) * extraDownscale, 1);
            clone.style.transformOrigin = 'top left';
            clone.style.transform = `scale(${scaleToFit})`;

            const opt = {
                margin: [10, 10, 10, 10],
                filename: `DPR_${proj}_${formattedDate}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, scrollY: 0, scrollX: 0, windowWidth: contentWidth },
                jsPDF: { unit: 'mm', format: 'a4', orientation },
                pagebreak: { mode: ['css', 'legacy'], avoid: ['tr', 'td', 'th', 'h2', 'h3', '.avoid-break'] }
            };

            // Remove bottom margin from last element to prevent blank page
            const lastEl = clone.lastElementChild;
            if (lastEl) lastEl.style.marginBottom = '0';
            const lastReport = clone.querySelector(':scope > div:last-child');
            if (lastReport) lastReport.style.marginBottom = '0';
            clone.style.marginBottom = '0';

            await html2pdf().from(clone).set(opt).save();
            document.body.removeChild(clone);
        }

        function downloadExcel() {
            const reports = getReports();
            if (!reports.length) { alert('No reports to export'); return; }

            const wb = XLSX.utils.book_new();

            reports.forEach((r, idx) => {
                const d = r.data || {};
                const aoa = [];

                // Title
                aoa.push([`Report ${r.report_number}`]);
                aoa.push([`${r.project_code} - ${r.project_name}`]);
                function fmtDate(d) {
                    if (!d) return '';
                    // Assuming d is YYYY-MM-DD
                    const parts = d.split('-');
                    if (parts.length === 3) return `${parts[2]}-${parts[1]}-${parts[0]}`;
                    return d;
                }
                const dateVal = fmtDate(r.report_date);
                aoa.push([`Date: ${dateVal}`]);
                aoa.push([]);

                // Project Details (4-column layout: label, value, label, value)
                aoa.push(['Project Manager (Contractor)', (d.projectManagerContractor || r.project_manager_contractor || ''), 'Project Manager (Client)', (d.projectManagerClient || r.project_manager_client || '')]);
                aoa.push(['Target Completion', (d.targetCompletion || r.target_completion || ''), 'Client', (d.client || r.project_client || '')]);
                aoa.push(['Contractor', (d.contractor || r.project_contractor || ''), 'Subcontractor Deployed', (d.subcontractorDeployed || '')]);
                const wxMax = (d.weather && d.weather.max) || '';
                const wxMin = (d.weather && d.weather.min) || '';
                aoa.push(['Weather', (wxMax || wxMin) ? `Max ${wxMax}째C / Min ${wxMin}째C` : '-', '', '']);
                aoa.push([]);

                // Construction Work Progress
                aoa.push(['Construction Work Progress']);
                aoa.push(['Activity', 'UOM', 'Total Qty', 'Planned Today', 'Achieved Today', 'Planned Cumulative', 'Achieved Cumulative']);
                const acts = (d.activities || []);
                const grouped = {};
                acts.forEach(a => {
                    const sec = a.sectionName || 'General';
                    if (!grouped[sec]) grouped[sec] = [];
                    grouped[sec].push(a);
                });
                Object.keys(grouped).forEach(sec => {
                    aoa.push([`Section: ${sec}`]);
                    grouped[sec].forEach(a => {
                        aoa.push([
                            a.description || '', a.unit || '', a.total_qty || '',
                            a.planned_today || 0, a.achieved_today || 0,
                            a.planned_cumulative || 0, a.achieved_cumulative || 0
                        ]);
                    });
                });
                aoa.push([]);

                // Manpower
                aoa.push(['Manpower']);
                aoa.push(['Contractor', 'Designation', 'Department', 'No. of Personnel']);
                const mp = (d.manpower || []);
                mp.forEach(m => aoa.push([m.contractor || '', m.designation || '', m.department || '', m.count || 0]));
                const mpTotal = mp.reduce((s, m) => s + (Number(m.count) || 0), 0);
                aoa.push(['Totals', '', '', mpTotal]);
                aoa.push([]);

                // Equipment
                aoa.push(['Equipment']);
                aoa.push(['Contractor', 'Equipment', 'Department', 'No. of Units', 'Effective Hours', 'Idle Hours']);
                const eq = (d.equipment || []);
                eq.forEach(e => aoa.push([e.contractor || '', e.description || '', e.department || '', e.count || 0, e.effective_hours || 0, e.idle_hours || 0]));
                const eqUnits = eq.reduce((s, e) => s + (Number(e.count) || 0), 0);
                const eqEff = eq.reduce((s, e) => s + (Number(e.effective_hours) || 0), 0);
                const eqIdle = eq.reduce((s, e) => s + (Number(e.idle_hours) || 0), 0);
                aoa.push(['Totals', '', '', eqUnits, eqEff, eqIdle]);
                aoa.push([]);

                // Concerns & Incidents
                aoa.push(['Concerns & Incidents']);
                aoa.push(['Any Quality concerns', d.concerns || 'Not filled']);
                aoa.push(['Mitigation (for mentioned concern)', d.mitigation || 'Not filled']);
                aoa.push(['Any Safety incident', d.incidents || 'Not filled']);
                aoa.push(['Action for avoidance', d.actionAvoidance || 'Not filled']);
                aoa.push([]);

                // Critical Issues
                aoa.push(['Critical Issues']);
                const ci = (d.criticalIssuesDetails || []);
                if (ci.length > 0) {
                    aoa.push(['Issue', 'Raised (Date)', 'Work Affected']);
                    ci.forEach(it => aoa.push([it.issue || '', fmtDate(it.dateRaised) || '', it.affected || '']));
                } else {
                    aoa.push([d.criticalIssues || 'Not filled']);
                }
                aoa.push([]);

                // Remarks
                if (d.remarks || d.additionalNotes) {
                    aoa.push(['Remarks']);
                    aoa.push([d.remarks || d.additionalNotes || '']);
                    aoa.push([]);
                }

                // Signatories
                aoa.push(['Signatories']);
                aoa.push(['Prepared By', (d.preparedBy || r.prepared_by || '-'), 'Initiated By (Contractor)', (d.initiatedByContractor || '-')]);
                if (d.checkedBy) aoa.push(['Checked By', d.checkedBy]);
                if (d.approvedBy) aoa.push(['Approved By', d.approvedBy]);
                aoa.push(['Verified By', d.verifiedBy || '-']);

                const ws = XLSX.utils.aoa_to_sheet(aoa);
                // Basic column widths
                ws['!cols'] = [
                    { wch: 28 }, { wch: 28 }, { wch: 28 }, { wch: 28 }, { wch: 18 }, { wch: 18 }, { wch: 18 }
                ];
                // Merge title rows across first 4 columns if present
                ws['!merges'] = ws['!merges'] || [];
                ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 3 } });
                ws['!merges'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 3 } });
                ws['!merges'].push({ s: { r: 2, c: 0 }, e: { r: 2, c: 3 } });

                // Sheet name per report
                const safeName = (`Rep_${r.report_number || idx}`).toString().substring(0, 31);
                XLSX.utils.book_append_sheet(wb, ws, safeName);
            });

            const projSel = document.getElementById('project');
            const dateSel = document.getElementById('report_date');
            const proj = projSel?.value || 'All';
            const rawDate = dateSel?.value || new Date().toISOString().slice(0, 10);
            const dateParts = rawDate.split('-');
            const formattedDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
            XLSX.writeFile(wb, `DPR_View_${proj}_${formattedDate}.xlsx`);
        }
        function formatIST(ts) {
            try {
                if (!ts) return '';
                const d = new Date(ts.replace(' ', 'T') + 'Z');
                return new Intl.DateTimeFormat('en-IN', {
                    timeZone: 'Asia/Kolkata', year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                }).format(d) + ' IST';
            } catch { return ts; }
        }
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('[data-ts]')?.forEach(el => {
                el.textContent = formatIST(el.getAttribute('data-ts'));
            });
        });
    </script>
</head>

<body class="bg-gray-100 min-h-screen">
    <script id="reports-json" type="application/json">{{ reports | tojson | safe }}</script>
    <nav class="bg-blue-900 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img src="https://simonindia.com/assets/images/logo.png" alt="SIMON India Logo" class="h-8">
                <h1 class="text-xl font-bold">View Reports</h1>
            </div>
            {% if show_admin_links %}
            <div class="flex items-center space-x-4 no-print" data-html2pdf-ignore>
                <a href="/admin" class="bg-blue-700 px-3 py-2 rounded hover:bg-blue-600 transition">Dashboard</a>
                <a href="/admin/logout" class="bg-red-600 px-3 py-2 rounded hover:bg-red-500 transition">Logout</a>
            </div>
            {% endif %}
        </div>
    </nav>

    <div id="reports-root" class="mx-auto p-6 w-full max-w-none">
        <div class="bg-white p-4 rounded shadow mb-6 no-print" data-html2pdf-ignore>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm text-gray-700 mb-1">Project</label>
                    <select id="project" class="w-full border rounded px-3 py-2">
                        <option value="">All Projects</option>
                        {% for p in projects %}
                        <option value="{{ p.code }}" {% if selected_project==p.code %}selected{% endif %}>{{ p.code }} -
                            {{ p.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-700 mb-1">Report Date</label>
                    <input id="report_date" type="date" value="{{ selected_date }}"
                        class="w-full border rounded px-3 py-2" />
                </div>
                <div class="flex items-end space-x-2">
                    <button onclick="applyFilters()"
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-500">Apply</button>
                    <button onclick="downloadClientPDF()"
                        class="px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-600">Download PDF</button>
                </div>
            </div>
        </div>

        {% if reports|length == 0 %}
        <div class="bg-yellow-50 border border-yellow-200 text-yellow-800 p-4 rounded">No reports found. Select filters
            and click Apply.</div>
        {% endif %}

        {% for r in reports %}
        <div class="bg-white p-8 rounded-lg shadow-lg mb-8 border border-gray-200">
            <!-- Header -->
            <div class="flex justify-between items-start mb-6 gap-6 pb-4 border-b-2 border-blue-100">
                <div class="flex-1 min-w-0">
                    <h2 class="text-2xl font-bold text-blue-900 mb-2">Report {{ r.report_number }}</h2>
                    <div class="flex flex-wrap gap-4 mb-4">
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">{{
                            r.project_code }}</span>
                        <span class="text-lg font-semibold text-gray-700">{{ r.project_name }}</span>
                    </div>
                    <p class="text-gray-600 mb-4"><span class="font-medium">Date:</span> {{
                        r.report_date.split('-')|reverse|join('-') if r.report_date else '' }}</p>
                    <div class="mt-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Project Details</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm border border-gray-300 rounded-lg overflow-hidden">
                                <tbody>
                                    <tr>
                                        <td
                                            class="px-4 py-3 border-b border-r bg-blue-50 w-64 font-medium text-blue-900">
                                            Project Manager (Contractor)</td>
                                        <td class="px-4 py-3 border-b border-r text-gray-800">{{
                                            r.data.projectManagerContractor or r.project_manager_contractor or '-' }}
                                        </td>
                                        <td
                                            class="px-4 py-3 border-b border-r bg-blue-50 w-64 font-medium text-blue-900">
                                            Project Manager (Client)</td>
                                        <td class="px-4 py-3 border-b text-gray-800">{{ r.data.projectManagerClient or
                                            r.project_manager_client or '-' }}</td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-3 border-b border-r bg-blue-50 font-medium text-blue-900">
                                            Target Completion</td>
                                        <td class="px-4 py-3 border-b border-r text-gray-800">{{ r.data.targetCompletion
                                            or r.target_completion or '-' }}</td>
                                        <td class="px-4 py-3 border-b border-r bg-blue-50 font-medium text-blue-900">
                                            Client</td>
                                        <td class="px-4 py-3 border-b text-gray-800">{{ r.data.client or
                                            r.project_client or '-' }}</td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-3 border-b border-r bg-blue-50 font-medium text-blue-900">
                                            Contractor</td>
                                        <td class="px-4 py-3 border-b border-r text-gray-800">{{ r.data.contractor or
                                            r.project_contractor or '-' }}</td>
                                        <td class="px-4 py-3 border-b border-r bg-blue-50 font-medium text-blue-900">
                                            Subcontractor Deployed</td>
                                        <td class="px-4 py-3 border-b text-gray-800">{{ r.data.subcontractorDeployed or
                                            '-' }}</td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-3 bg-blue-50 font-medium text-blue-900 border-r">Weather</td>
                                        <td class="px-4 py-3 text-gray-800" colspan="3">
                                            {% if r.data.weather and (r.data.weather.max or r.data.weather.min) %}
                                            <span class="inline-flex items-center gap-2">
                                                <span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs">Max {{
                                                    r.data.weather.max or '?' }}째C</span>
                                                <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">Min {{
                                                    r.data.weather.min or '?' }}째C</span>
                                            </span>
                                            {% else %}
                                            -
                                            {% endif %}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="flex-shrink-0">
                    <img src="/static/logo.png" alt="Simon India Logo" class="h-12 object-contain">
                </div>
                <!-- Submitted date removed as requested -->
            </div>

            <!-- Construction Work Progress (Activities) -->
            <div class="mb-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <span class="w-1 h-6 bg-blue-600 rounded mr-3"></span>
                    Construction Work Progress
                </h3>
                {% set act_list = r.data.activities or [] %}
                {% if act_list|length == 0 %}
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center text-gray-500">No activities
                    recorded</div>
                {% else %}
                {% set grouped = {} %}
                {% for a in act_list %}
                {% set sec = a.sectionName or 'General' %}
                {% if grouped.update({sec: (grouped.get(sec, []) + [a])}) %}{% endif %}
                {% endfor %}
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm border border-gray-300 rounded-lg overflow-hidden">
                        <thead class="bg-gradient-to-r from-blue-600 to-blue-700 text-white">
                            <tr>
                                <th class="text-left px-4 py-3 font-semibold">Activity</th>
                                <th class="text-left px-4 py-3 font-semibold">UOM</th>
                                <th class="text-right px-4 py-3 font-semibold">Total Qty</th>
                                <th class="text-right px-4 py-3 font-semibold">Planned Today</th>
                                <th class="text-right px-4 py-3 font-semibold">Achieved Today</th>
                                <th class="text-right px-4 py-3 font-semibold">Planned Cumulative</th>
                                <th class="text-right px-4 py-3 font-semibold">Achieved Cumulative</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sec_name, items in grouped.items() %}
                            <tr class="bg-gradient-to-r from-gray-100 to-gray-50">
                                <td class="px-4 py-3 font-bold text-gray-800 text-base border-b" colspan="7">
                                    <span class="inline-flex items-center">
                                        <span class="w-2 h-2 bg-blue-600 rounded-full mr-2"></span>
                                        {{ sec_name }}
                                    </span>
                                </td>
                            </tr>
                            {% for a in items %}
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-4 py-3 border-b border-gray-200">{{ a.description }}</td>
                                <td class="px-4 py-3 border-b border-gray-200">{{ a.unit or '' }}</td>
                                <td class="px-4 py-3 border-b border-gray-200 text-right">{{ a.total_qty or '' }}</td>
                                <td class="px-4 py-3 border-b border-gray-200 text-right font-medium">{{ a.planned_today
                                    }}</td>
                                <td class="px-4 py-3 border-b border-gray-200 text-right font-medium">{{
                                    a.achieved_today }}</td>
                                <td class="px-4 py-3 border-b border-gray-200 text-right font-medium">{{
                                    a.planned_cumulative }}</td>
                                <td class="px-4 py-3 border-b border-gray-200 text-right font-medium">{{
                                    a.achieved_cumulative }}</td>
                            </tr>
                            {% endfor %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>

            <!-- Manpower -->
            {% set mp_list = r.data.manpower or [] %}
            {% set eq_list = r.data.equipment or [] %}
            {% if mp_list|length == 0 and eq_list|length == 0 %}
            <div class="mb-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <span class="w-1 h-6 bg-green-600 rounded mr-3"></span>
                    Manpower & Equipment
                </h3>
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center text-gray-500">No manpower or
                    equipment recorded</div>
            </div>
            {% endif %}

            {% if mp_list|length > 0 %}
            <div class="mb-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <span class="w-1 h-6 bg-green-600 rounded mr-3"></span>
                    Manpower Details
                </h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm border border-gray-300 rounded-lg overflow-hidden">
                        <thead class="bg-gradient-to-r from-green-600 to-green-700 text-white">
                            <tr>
                                <th class="text-left px-4 py-3 font-semibold">Contractor</th>
                                <th class="text-left px-4 py-3 font-semibold">Designation</th>
                                <th class="text-left px-4 py-3 font-semibold">Department</th>
                                <th class="text-left px-4 py-3 font-semibold">No. of Personnel</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for m in mp_list %}
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-4 py-3 border-b border-gray-200">{{ m.contractor }}</td>
                                <td class="px-4 py-3 border-b border-gray-200">{{ m.designation }}</td>
                                <td class="px-4 py-3 border-b border-gray-200">{{ m.department }}</td>
                                <td class="px-4 py-3 border-b border-gray-200">{{ m.count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="bg-gray-50 font-semibold">
                                <td class="px-4 py-3 border-t border-gray-300" colspan="3">Totals</td>
                                <td class="px-4 py-3 border-t border-gray-300">{{ mp_list | map(attribute='count') | sum
                                    }}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Equipment -->
            {% if eq_list|length > 0 %}
            <div class="border-t pt-4 mt-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <span class="w-1 h-6 bg-green-600 rounded mr-3"></span>
                    Equipment Details
                </h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm border border-gray-300 rounded-lg overflow-hidden">
                        <thead class="bg-gradient-to-r from-green-600 to-green-700 text-white">
                            <tr>
                                <th class="text-left px-4 py-3 font-semibold">Contractor</th>
                                <th class="text-left px-4 py-3 font-semibold">Equipment</th>
                                <th class="text-left px-4 py-3 font-semibold">Department</th>
                                <th class="text-left px-4 py-3 font-semibold">No. of Units</th>
                                <th class="text-left px-4 py-3 font-semibold">Effective Hours</th>
                                <th class="text-left px-4 py-3 font-semibold">Idle Hours</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for e in eq_list %}
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-4 py-3 border-b border-gray-200">{{ e.contractor }}</td>
                                <td class="px-4 py-3 border-b border-gray-200">{{ e.description }}</td>
                                <td class="px-4 py-3 border-b border-gray-200">{{ e.department }}</td>
                                <td class="px-4 py-3 border-b border-gray-200">{{ e.count }}</td>
                                <td class="px-4 py-3 border-b border-gray-200">{{ e.effective_hours or 0 }}</td>
                                <td class="px-4 py-3 border-b border-gray-200">{{ e.idle_hours or 0 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="bg-gray-50 font-semibold">
                                <td class="px-4 py-3 border-t border-gray-300" colspan="3">Totals</td>
                                <td class="px-4 py-3 border-t border-gray-300">{{ eq_list | map(attribute='count') | sum
                                    }}</td>
                                <td class="px-4 py-3 border-t border-gray-300">{{ eq_list |
                                    map(attribute='effective_hours') | sum }}</td>
                                <td class="px-4 py-3 border-t border-gray-300">{{ eq_list | map(attribute='idle_hours')
                                    | sum }}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Concerns & Incidents -->
            <div class="border-t pt-4 mt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">Concerns & Incidents</h3>
                    <div class="space-y-2">
                        <div>
                            <div class="text-xs text-gray-500">Any Quality concerns</div>
                            <p class="text-sm text-gray-800 whitespace-pre-line">{{ r.data.concerns or 'Not filled' }}
                            </p>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500">Mitigation (for mentioned concern)</div>
                            <p class="text-sm text-gray-800 whitespace-pre-line">{{ r.data.mitigation or 'Not filled' }}
                            </p>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500">Any Safety incident</div>
                            <p class="text-sm text-gray-800 whitespace-pre-line">{{ r.data.incidents or 'Not filled' }}
                            </p>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500">Action for avoidance</div>
                            <p class="text-sm text-gray-800 whitespace-pre-line">{{ r.data.actionAvoidance or 'Not
                                filled' }}</p>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">Critical Issues</h3>
                    {% if r.data.criticalIssuesDetails and r.data.criticalIssuesDetails|length > 0 %}
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm border">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="text-left p-2 border" style="width: 50%;">Issue</th>
                                    <th class="text-left p-2 border" style="width: 120px;">Raised (Date)</th>
                                    <th class="text-left p-2 border">Work Affected</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in r.data.criticalIssuesDetails %}
                                <tr>
                                    <td class="p-2 border">{{ item.issue }}</td>
                                    <td class="p-2 border">{{ item.dateRaised.split('-')|reverse|join('-') if
                                        item.dateRaised else '' }}</td>
                                    <td class="p-2 border">{{ item.affected }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-sm text-gray-800 whitespace-pre-line">{{ r.data.criticalIssues or 'Not filled' }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Remarks -->
            {% if r.data.remarks or r.data.additionalNotes %}
            <div class="border-t pt-4 mt-4">
                <h3 class="font-semibold text-gray-700 mb-2">Remarks</h3>
                <p class="text-sm text-gray-800 whitespace-pre-line">{{ r.data.remarks or r.data.additionalNotes }}</p>
            </div>
            {% endif %}

            {% if r.data.hindrances or r.data.safetyNotes or r.data.logisticsNotes %}
            <div class="border-t pt-4 mt-4 grid grid-cols-1 md:grid-cols-3 gap-6">
                {% if r.data.hindrances %}
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">Hindrances</h3>
                    <p class="text-sm text-gray-800 whitespace-pre-line">{{ r.data.hindrances }}</p>
                </div>
                {% endif %}
                {% if r.data.safetyNotes %}
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">Safety Notes</h3>
                    <p class="text-sm text-gray-800 whitespace-pre-line">{{ r.data.safetyNotes }}</p>
                </div>
                {% endif %}
                {% if r.data.logisticsNotes %}
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">Logistics</h3>
                    <p class="text-sm text-gray-800 whitespace-pre-line">{{ r.data.logisticsNotes }}</p>
                </div>
                {% endif %}
            </div>
            {% endif %}

            {% if r.data.photos and r.data.photos|length > 0 %}
            <div class="border-t pt-4 mt-4">
                <h3 class="font-semibold text-gray-700 mb-2">Photos</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    {% for p in r.data.photos %}
                    <div class="border rounded overflow-hidden">
                        <img src="{{ p.url or p }}" alt="Report Photo" class="w-full h-32 object-cover">
                        {% if p.caption %}
                        <div class="p-2 text-xs text-gray-600">{{ p.caption }}</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Signatures -->
            <div class="border-t pt-4 mt-4 grid grid-cols-1 sm:grid-cols-3 gap-6">
                <div>
                    <div class="text-gray-500 text-xs">Prepared By</div>
                    <div class="font-medium">{{ r.data.preparedBy or r.prepared_by or 'Not filled' }}</div>
                </div>
                {% if r.data.checkedBy %}
                <div>
                    <div class="text-gray-500 text-xs">Checked By</div>
                    <div class="font-medium">{{ r.data.checkedBy }}</div>
                </div>
                {% endif %}
                {% if r.data.approvedBy %}
                <div>
                    <div class="text-gray-500 text-xs">Approved By</div>
                    <div class="font-medium">{{ r.data.approvedBy }}</div>
                </div>
                {% endif %}
            </div>
            <div class="pt-4 grid grid-cols-1 sm:grid-cols-2 gap-6">
                <div>
                    <div class="text-gray-500 text-xs">Initiated By (Contractor)</div>
                    <div class="font-medium">{{ r.data.initiatedByContractor or 'Not filled' }}</div>
                </div>
                <div>
                    <div class="text-gray-500 text-xs">Verified By</div>
                    <div class="font-medium">{{ r.data.verifiedBy or 'Not filled' }}</div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</body>

</html>
