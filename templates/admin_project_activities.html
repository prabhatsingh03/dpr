<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Project Activities</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Project Activities Management</h1>
                <div class="space-x-2">
                    <a href="/admin" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition">Back to Admin</a>
                    <a href="/admin/logout" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition">Logout</a>
                </div>
            </div>

            <!-- Add New Activity Form -->
            <div class="mb-8 p-4 bg-gray-50 rounded-lg">
                <h2 class="text-lg font-semibold mb-4">Add New Project Activity</h2>
                <form id="add-activity-form" class="grid grid-cols-1 md:grid-cols-6 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Project</label>
                        <select id="project-code" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required onchange="loadSections()">
                            <option value="">Select Project</option>
                            {% for project in projects %}
                            <option value="{{ project.code }}">{{ project.code }} - {{ project.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Section</label>
                        <select id="section-id" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                            <option value="">Select Section</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Activity Description</label>
                        <input type="text" id="activity-description" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Area</label>
                        <input type="text" id="area" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Unit</label>
                        <input type="text" id="unit" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Total Qty</label>
                        <input type="number" id="total-qty" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-6">
                        <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition">Add Activity</button>
                    </div>
                </form>
            </div>

            <!-- Activities Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Section</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Activity Description</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Area</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Qty</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for activity in activities %}
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ activity.project_code }} - {{ activity.project_name }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ activity.section_name }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ activity.activity_description }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ activity.area or '' }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ activity.unit }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ activity.total_qty_planned }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button onclick="editActivity({{ activity.id }})" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                                <button onclick="deleteActivity({{ activity.id }})" class="text-red-600 hover:text-red-900">Delete</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const sectionsData = {{ sections | tojson }};

        // Load sections based on selected project
        function loadSections() {
            const projectCode = document.getElementById('project-code').value;
            const sectionSelect = document.getElementById('section-id');
            
            // Clear existing options
            sectionSelect.innerHTML = '<option value="">Select Section</option>';
            
            if (projectCode) {
                // Filter sections for the selected project
                const projectSections = sectionsData.filter(section => section.project_code === projectCode);
                
                projectSections.forEach(section => {
                    const option = document.createElement('option');
                    option.value = section.id;
                    option.textContent = section.section_name;
                    sectionSelect.appendChild(option);
                });
            }
        }

        // Add/Edit activity
        document.getElementById('add-activity-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const form = e.target;
            const isEdit = form.dataset.editId;
            
            const formData = {
                projectCode: document.getElementById('project-code').value,
                sectionId: document.getElementById('section-id').value,
                activityDescription: document.getElementById('activity-description').value,
                area: document.getElementById('area').value,
                unit: document.getElementById('unit').value,
                totalQtyPlanned: parseInt(document.getElementById('total-qty').value) || 0
            };

            try {
                const url = isEdit ? `/admin/project-activities/update/${form.dataset.editId}` : '/admin/project-activities/add';
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (result.success) {
                    alert(isEdit ? 'Activity updated successfully!' : 'Activity added successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert(isEdit ? 'Error updating activity' : 'Error adding activity');
            }
        });

        // Delete activity
        async function deleteActivity(activityId) {
            if (!confirm('Are you sure you want to delete this activity?')) {
                return;
            }

            try {
                const response = await fetch(`/admin/project-activities/delete/${activityId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('Activity deleted successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error deleting activity');
            }
        }

        // Edit activity
        function editActivity(activityId) {
            // Find the row data
            const row = document.querySelector(`button[onclick="editActivity(${activityId})"]`).closest('tr');
            const cells = row.querySelectorAll('td');
            
            // Extract current values
            const currentProjectCode = cells[0].textContent.split(' - ')[0];
            const currentSectionName = cells[1].textContent;
            const currentActivityDescription = cells[2].textContent;
            const currentArea = cells[3].textContent;
            const currentUnit = cells[4].textContent;
            const currentTotalQty = cells[5].textContent;
            
            // Populate form with current values
            document.getElementById('project-code').value = currentProjectCode;
            loadSections(); // Load sections for the selected project
            
            // Wait a bit for sections to load, then set the section
            setTimeout(() => {
                const sectionSelect = document.getElementById('section-id');
                for (let option of sectionSelect.options) {
                    if (option.text === currentSectionName) {
                        option.selected = true;
                        break;
                    }
                }
            }, 100);
            
            document.getElementById('activity-description').value = currentActivityDescription;
            document.getElementById('area').value = currentArea;
            document.getElementById('unit').value = currentUnit;
            document.getElementById('total-qty').value = currentTotalQty;
            
            // Change form to edit mode
            const form = document.getElementById('add-activity-form');
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Update Activity';
            submitBtn.className = 'bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 transition';
            
            // Store the activity ID for update
            form.dataset.editId = activityId;
            
            // Add cancel button
            if (!document.getElementById('cancel-edit-btn')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.type = 'button';
                cancelBtn.id = 'cancel-edit-btn';
                cancelBtn.textContent = 'Cancel';
                cancelBtn.className = 'bg-gray-600 text-white px-6 py-2 rounded-md hover:bg-gray-700 transition ml-2';
                cancelBtn.onclick = cancelEdit;
                submitBtn.parentNode.appendChild(cancelBtn);
            }
        }
        
        // Cancel edit mode
        function cancelEdit() {
            const form = document.getElementById('add-activity-form');
            const submitBtn = form.querySelector('button[type="submit"]');
            const cancelBtn = document.getElementById('cancel-edit-btn');
            
            // Reset form
            form.reset();
            delete form.dataset.editId;
            
            // Reset button
            submitBtn.textContent = 'Add Activity';
            submitBtn.className = 'bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition';
            
            // Remove cancel button
            if (cancelBtn) {
                cancelBtn.remove();
            }
        }
    </script>
</body>
</html>
